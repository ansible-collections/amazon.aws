# SonarCloud analysis after CI passes (i.e. triggers when "all_green" workflow completes).

---
name: SonarCloud

on:
  workflow_run:
    workflows:
      - all_green
    types:
      - completed

permissions:
  contents: read
  pull-requests: read

jobs:
  finalize:
    name: finalize
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          show-progress: false

      - name: Get PR number and info
        if: github.event.workflow_run.event == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
          REPO: ${{ github.repository }}
        run: |
          PR_NUMBER=$(gh pr list --head "$HEAD_BRANCH" --repo "$REPO" --json number -q '.[0].number')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          if [ -n "$PR_NUMBER" ]; then
            PR_DATA=$(gh api "repos/$REPO/pulls/$PR_NUMBER")
            echo "PR_BASE=$(echo "$PR_DATA" | jq -r '.base.ref')" >> $GITHUB_ENV
            echo "PR_HEAD=$(echo "$PR_DATA" | jq -r '.head.ref')" >> $GITHUB_ENV
          fi

      - name: Prepare SonarCloud args
        env:
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
          EVENT_TYPE: ${{ github.event.workflow_run.event }}
        run: |
          SONAR_ARGS="-Dsonar.scm.revision=\"${COMMIT_SHA}\""
          if [[ "$EVENT_TYPE" == "pull_request" && -n "$PR_NUMBER" ]]; then
            SONAR_ARGS="${SONAR_ARGS} -Dsonar.pullrequest.key=\"${PR_NUMBER}\""
            SONAR_ARGS="${SONAR_ARGS} -Dsonar.pullrequest.branch=\"${PR_HEAD}\""
            SONAR_ARGS="${SONAR_ARGS} -Dsonar.pullrequest.base=\"${PR_BASE}\""
          fi
          echo "SONAR_ARGS=${SONAR_ARGS}" >> $GITHUB_ENV

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.ANSIBLE_COLLECTIONS_ORG_SONAR_TOKEN_CICD_BOT }}
        with:
          args: ${{ env.SONAR_ARGS }}
