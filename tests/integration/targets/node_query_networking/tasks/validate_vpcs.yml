---
- name: List VPCs
  amazon.aws.ec2_vpc_net_info:
    vpc_ids: "{{ vpcs_ids }}"
  register: vpcs_facts

- vars:
    expected_result: "{{ lookup('ansible.builtin.template', 'vpcs.j2') | from_yaml }}"
  block:
    - name: Run jq query on result data
      ansible.builtin.set_fact:
        node_count: "{{ vpcs_facts | to_json | aws_jq(event_node_queries.ec2_vpc_net_info) }}"

    - name: Validate result is as expected
      ansible.builtin.assert:
        that:
          - node_count | sort(attribute='name') == expected_result | sort(attribute='name')
      register: test_result
  always:
    - name: Display expected result
      ansible.builtin.debug:
        var: expected_result
      when: test_result is failed
    - name: Display actual result
      ansible.builtin.debug:
        var: node_count
      when: test_result is failed
