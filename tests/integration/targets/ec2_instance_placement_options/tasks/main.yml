- module_defaults:
    group/aws:
      access_key: "{{ aws_access_key }}"
      secret_key: "{{ aws_secret_key }}"
      session_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  block:
  - name: "New instance with dedicated tenancy"
    ec2_instance:
      state: running
      name: "{{ resource_prefix }}-test-ebs-vols"
      image_id: "{{ ec2_ami_id }}"
      vpc_subnet_id: "{{ testing_subnet_b.subnet.id }}"
      placement:
        tenancy: "{{ ec2_tenancy }}"
      tags:
        TestId: "{{ ec2_instance_tag_TestId }}"
      instance_type: "{{ ec2_instance_type }}"
      wait: true
    register: instance_creation

  - name: "Instance with placement set to host tenancy"
    assert:
      that:
        - instance_creation is success
        - instance_creation is changed
        - "'{{ instance_creation.spec.Placement.Tenancy }}' == 'dedicated'"

  - name: "New instance with placement group name"
    ec2_instance:
      state: running
      name: "{{ resource_prefix }}-test-ebs-vols"
      image_id: "{{ ec2_ami_id }}"
      vpc_subnet_id: "{{ testing_subnet_b.subnet.id }}"
      placement:
        group_name: "{{ ec2_placement_group_name }}"
      tags:
        TestId: "{{ ec2_instance_tag_TestId }}"
      instance_type: "{{ ec2_instance_type }}"
      wait: true
    register: instance_creation

  - name: "Instance with placement group name"
    assert:
      that:
        - instance_creation is success
        - instance_creation is changed
        - "'{{ instance_creation.spec.Placement.GroupName }}' == '{{ ec2_placement_group_name }}'"
