- name: Add Managed Policy (CHECK MODE)
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ safe_managed_policy }}'
  check_mode: yes
  register: iam_group
- assert:
    that:
      - iam_group is changed

- name: Add Managed Policy
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ safe_managed_policy }}'
  register: iam_group
- assert:
    that:
      - iam_group is changed
      - iam_group.iam_group.group.group_name == test_group
      - iam_group.iam_group.attached_policies | length == 1
      - iam_group.iam_group.attached_policies[0].policy_name == safe_managed_policy

- name: Add Managed Policy (no change) - check mode
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ safe_managed_policy }}'
  register: iam_group
  check_mode: yes
- assert:
    that:
      - iam_group is not changed

- name: Add Managed Policy (no change)
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ safe_managed_policy }}'
  register: iam_group
- assert:
    that:
      - iam_group is not changed
      - iam_group.iam_group.group.group_name == test_group
      - iam_group.iam_group.attached_policies | length == 1
      - iam_group.iam_group.attached_policies[0].policy_name == safe_managed_policy

# ------------------------------------------------------------------------------------------

- name: Update Managed Policy without purge (CHECK MODE)
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ custom_policy_name }}'
  check_mode: yes
  register: iam_group
- assert:
    that:
      - iam_group is changed

- name: Update Managed Policy without purge
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ custom_policy_name }}'
  register: iam_group
- assert:
    that:
      - iam_group is changed
      - iam_group.iam_group.group.group_name == test_group
      - iam_group.iam_group.attached_policies | length == 2
      - custom_policy_name in attached_policy_names
      - safe_managed_policy in attached_policy_names
  vars:
    attached_policy_names: "{{ iam_group.iam_group.attached_policies | map(attribute='policy_name') }}"

- name: Update Managed Policy without purge (no change) - check mode
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ custom_policy_name }}'
  register: iam_group
  check_mode: yes
- assert:
    that:
      - iam_group is not changed

- name: Update Managed Policy without purge (no change)
  iam_group:
    name: '{{ test_group }}'
    state: present
    purge_policies: no
    managed_policy:
      - '{{ custom_policy_name }}'
  register: iam_group
- assert:
    that:
      - iam_group is not changed
      - iam_group.iam_group.group.group_name == test_group
      - iam_group.iam_group.attached_policies | length == 2
      - custom_policy_name in attached_policy_names
      - safe_managed_policy in attached_policy_names
  vars:
    attached_policy_names: "{{ iam_group.iam_group.attached_policies | map(attribute='policy_name') }}"

# ------------------------------------------------------------------------------------------

- name: Update Managed Policy with purge (CHECK MODE)
  iam_group:
    name: '{{ test_group }}'
    state: present
    managed_policy:
      - '{{ custom_policy_name }}'
    purge_policies: yes
  check_mode: yes
  register: iam_group
- assert:
    that:
      - iam_group is changed

- name: Update Managed Policy with purge
  iam_group:
    name: '{{ test_group }}'
    state: present
    managed_policy:
      - '{{ custom_policy_name }}'
    purge_policies: yes
  register: iam_group
- assert:
    that:
      - iam_group is changed
      - iam_group.iam_group.group.group_name == test_group
      - iam_group.iam_group.attached_policies | length == 1
      - custom_policy_name in attached_policy_names
      - safe_managed_policy not in attached_policy_names
  vars:
    attached_policy_names: "{{ iam_group.iam_group.attached_policies | map(attribute='policy_name') }}"

- name: Update Managed Policy with purge (no change) - check mode
  iam_group:
    name: '{{ test_group }}'
    state: present
    managed_policy:
      - '{{ custom_policy_name }}'
    purge_policies: yes
  register: iam_group
  check_mode: yes
- assert:
    that:
      - iam_group is not changed

- name: Update Managed Policy with purge (no change)
  iam_group:
    name: '{{ test_group }}'
    state: present
    managed_policy:
      - '{{ custom_policy_name }}'
    purge_policies: yes
  register: iam_group
- assert:
    that:
      - iam_group is not changed
      - iam_group.iam_group.group.group_name == test_group
      - iam_group.iam_group.attached_policies | length == 1
      - custom_policy_name in attached_policy_names
      - safe_managed_policy not in attached_policy_names
  vars:
    attached_policy_names: "{{ iam_group.iam_group.attached_policies | map(attribute='policy_name') }}"
