---
- name: add non existent user to group
  iam_group:
    name: '{{ test_group }}'
    users:
      - '{{ test_user }}'
      - NonExistentUser
    state: present
  ignore_errors: yes
  register: iam_group

- name: assert that adding non existent user to group fails with helpful message
  assert:
    that:
      - iam_group is failed
      - iam_group.msg.startswith("Couldn't add user NonExistentUser to group {{ test_group }}")

- name: remove a user
  iam_group:
    name: '{{ test_group }}'
    purge_users: True
    users: []
    state: present
  register: iam_group

- assert:
    that:
      - iam_group is changed
      - '"users" in iam_group.iam_group'
      - iam_group.iam_group.users | length == 0

- name: re-remove a user (no change)
  iam_group:
    name: '{{ test_group }}'
    purge_users: True
    users: []
    state: present
  register: iam_group

- assert:
    that:
      - iam_group is not changed
      - '"users" in iam_group.iam_group'
      - iam_group.iam_group.users | length == 0

- name: Add the user again
  iam_group:
    name: '{{ test_group }}'
    users:
      - '{{ test_user }}'
    state: present
  register: iam_group

- assert:
    that:
      - iam_group is changed
      - '"users" in iam_group.iam_group'
      - iam_group.iam_group.users | length == 1
      - iam_group.iam_group.users[0].user_name == test_user

- name: Re-add the user
  iam_group:
    name: '{{ test_group }}'
    users:
      - '{{ test_user }}'
    state: present
  register: iam_group

- assert:
    that:
      - iam_group is not changed
      - '"users" in iam_group.iam_group'
      - iam_group.iam_group.users | length == 1
      - iam_group.iam_group.users[0].user_name == test_user
