- block:
  - name: define bucket name used for tests
    set_fact:
      copy_bucket:
        src: "{{ bucket_name | hash('md5')}}copysrc"
        dst: "{{ bucket_name | hash('md5')}}copydst"
  
  - name: create bucket source
    aws_s3:
      bucket: "{{ copy_bucket.src }}"
      mode: create
  
  - name: Create content
    set_fact:
      content: "{{ lookup('password', '/dev/null chars=ascii_letters,digits,hexdigits,punctuation') }}"

  - name: Put a content in the source bucket
    aws_s3:
      bucket: "{{ copy_bucket.src }}"
      mode: put
      content: "{{ content }}"
      object: source.txt
    retries: 3
    delay: 3
    register: result
    until: "result.msg == 'PUT operation complete'"
  
  - name: test list to get all objects in the bucket
    aws_s3:
      bucket: "{{ copy_bucket.src }}"
      mode: list
  
  - name: Copy the content of the source bucket into dest bucket
    aws_s3:
      bucket: "{{ copy_bucket.dst }}"
      mode: copy
      object: destination.txt
      copy_src:
        bucket: "{{ copy_bucket.src }}"
        object: source.txt
  
  - name: Get the content copied into {{ copy_bucket.dst }}
    aws_s3:
      bucket: "{{ copy_bucket.dst }}"
      mode: getstr
      object: destination.txt
    register: copy_content
  
  - name: assert that the content is matching with the source
    assert:
      that:
        - content == copy_content.contents
  
  - name: Copy the same content from the source bucket into dest bucket (idempotency)
    aws_s3:
      bucket: "{{ copy_bucket.dst }}"
      mode: copy
      object: destination.txt
      copy_src:
        bucket: "{{ copy_bucket.src }}"
        object: source.txt
    register: copy_idempotency
  
  - name: assert that no change was made
    assert:
      that:
        - not copy_idempotency.changed
        - "copy_idempotency.msg == 'ETag from source and destination are the same'"

  always:
    - include_tasks: delete_bucket.yml
      with_items:
        - "{{ copy_bucket.dst }}"
        - "{{ copy_bucket.src }}"
