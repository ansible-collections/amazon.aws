- module_defaults:
    group/aws:
      access_key: "{{ aws_access_key }}"
      secret_key: "{{ aws_secret_key }}"
      session_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  block:
  - name: Create a cluster placement group
    amazon.aws.ec2_placement_group:
      group_name: "{{ ec2_placement_group_name }}-cluster"
      strategy: cluster
      state: present
    register: cluster_placement_group
  
  - name: Validate cluster placement group
    ansible.builtin.assert:
      that:
      - cluster_placement_group.group.state == 'present'

  - name: Create a partition placement group
    amazon.aws.ec2_placement_group:
      group_name: "{{ ec2_placement_group_name }}-partition"
      strategy: partition
      partition_count: 2
      state: present
    register: partition_placement_group
  
  - name: Validate partition placement group
    ansible.builtin.assert:
      that:
      - partition_placement_group.group.partition_count == 2
      - partition_placement_group.group.state == 'present'

  - name: Create a spread placement group
    amazon.aws.ec2_placement_group:
      group_name: "{{ ec2_placement_group_name }}-spread"
      strategy: spread
      spread_domain: host
      state: present
    register: spread_placement_group

  - name: Validate spread placement group
    ansible.builtin.assert:
      that:
      - spread_placement_group.group.spread_domain == 'host'
      - spread_placement_group.group.state == 'present'

  - name: Delete a cluster placement group
    ansible.aws.ec2_placement_group:
      group_name: "{{ ec2_placement_group_name }}-cluster"
      state: absent

  - name: Delete a partition placement group
    ansible.aws.ec2_placement_group:
      group_name: "{{ ec2_placement_group_name }}-partition"
      state: absent
  
  - name: Delete a spread placement group
    ansible.aws.ec2_placement_group:
      group_name: "{{ ec2_placement_group_name }}-spread"
      state: absent