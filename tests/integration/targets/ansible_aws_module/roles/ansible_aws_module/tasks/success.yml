---
##################################################################################
# Tests using standard credential parameters

- name: 'Test basic operation using simple credentials (simple-parameters)'
  boto3_example:
    region: '{{ aws_region }}'
    access_key: '{{ aws_access_key }}'
    secret_key: '{{ aws_secret_key }}'
    security_token: '{{ security_token }}'
  register: credential_result

- name: 'Test basic operation using simple credentials (aws-parameters)'
  boto3_example:
    aws_region: '{{ aws_region }}'
    aws_access_key: '{{ aws_access_key }}'
    aws_secret_key: '{{ aws_secret_key }}'
    aws_security_token: '{{ security_token }}'
  register: credential_result

- name: 'Test basic operation using simple credentials (ec2-parameters)'
  boto3_example:
    ec2_region: '{{ aws_region }}'
    ec2_access_key: '{{ aws_access_key }}'
    ec2_secret_key: '{{ aws_secret_key }}'
    access_token: '{{ security_token }}'
  register: credential_result

##################################################################################
# Tests using standard credentials from environment variables

- name: 'Test basic operation using simple credentials (aws-environment)'
  boto3_example:
  environment:
    AWS_REGION: '{{ aws_region }}'
    AWS_ACCESS_KEY_ID: '{{ aws_access_key }}'
    AWS_SECRET_ACCESS_KEY: '{{ aws_secret_key }}'
    AWS_SECURITY_TOKEN: '{{ security_token }}'
  register: credential_result

- name: 'Test basic operation using simple credentials (aws2-environment)'
  boto3_example:
  environment:
    AWS_DEFAULT_REGION: '{{ aws_region }}'
    AWS_ACCESS_KEY: '{{ aws_access_key }}'
    AWS_SECRET_KEY: '{{ aws_secret_key }}'
    AWS_SESSION_TOKEN: '{{ security_token }}'
  register: credential_result

- name: 'Test basic operation using simple credentials (ec2-environment)'
  boto3_example:
  environment:
    EC2_REGION: '{{ aws_region }}'
    EC2_ACCESS_KEY: '{{ aws_access_key }}'
    EC2_SECRET_KEY: '{{ aws_secret_key }}'
    EC2_SECURITY_TOKEN: '{{ security_token }}'
  register: credential_result

##################################################################################
# Tests using profiles instead of directly consuming credentials

- name: 'Test basic operation using profile (simple-parameters)'
  boto3_example:
    profile: 'test_profile'
  register: profile_result

- name: 'Test basic operation using profile (aws-parameters)'
  boto3_example:
    profile: 'test_profile'
  register: profile_result

- name: 'Test basic operation using profile (aws-environment)'
  boto3_example:
  environment:
    AWS_PROFILE: 'test_profile'
  register: profile_result

- name: 'Test basic operation using profile (aws2-environment)'
  boto3_example:
  environment:
    AWS_DEFAULT_PROFILE: 'test_profile'
  register: profile_result

##################################################################################
# Tests using profiles instead of directly consuming credentials

- name: 'Test basic operation using standard endpoint (aws-parameters)'
  boto3_example:
    region: '{{ aws_region }}'
    aws_endpoint_url: 'https://ec2.{{ aws_region }}.amazonaws.com'
    aws_access_key: '{{ aws_access_key }}'
    aws_secret_key: '{{ aws_secret_key }}'
    aws_security_token: '{{ security_token }}'
  register: standard_endpoint_result

- name: 'Check that we connected to the standard endpoint'
  assert:
    that:
    - standard_endpoint_result is successful
    - '"ec2:DescribeImages" in standard_endpoint_result.resource_actions'

# The FIPS endpoints aren't available in every region, this will trigger errors
# outside of: [ us-east-1, us-east-2, us-west-1, us-west-2 ]

- name: 'Test basic operation using FIPS endpoint (aws-parameters)'
  boto3_example:
    region: '{{ aws_region }}'
    aws_endpoint_url: 'https://ec2-fips.{{ aws_region }}.amazonaws.com'
    aws_access_key: '{{ aws_access_key }}'
    aws_secret_key: '{{ aws_secret_key }}'
    aws_security_token: '{{ security_token }}'
  register: fips_endpoint_result

- name: 'Check that we connected to the FIPS endpoint'
  assert:
    that:
    - fips_endpoint_result is successful
    - '"ec2-fips:DescribeImages" in fips_endpoint_result.resource_actions'
