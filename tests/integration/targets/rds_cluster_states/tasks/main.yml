- module_defaults:
    group/aws:
      region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token | default(omit) }}'
  block:
    # ------------------------------------------------------------------------------------------
    # Create DB cluster
    - name: Ensure the resource doesn't exist
      rds_cluster:
        id: '{{ cluster_id }}'
        state: absent
        engine: '{{ engine}}'
        username: '{{ username }}'
        password: '{{ password }}'
        skip_final_snapshot: true
      register: _result_delete_db_cluster

    - assert:
        that:
        - not _result_delete_db_cluster.changed
      ignore_errors: yes

    - name: Create an Aurora-PostgreSQL DB cluster
      rds_cluster:
        id: '{{ cluster_id }}'
        state: present
        engine: aurora-postgresql
        engine_mode: provisioned
        db_cluster_instance_class: '{{ db_cluster_instance_class }}'
        username: '{{ username }}'
        password: '{{ password }}'
      register: _result_create_source_db_cluster

    - assert:
        that:
        - _result_create_source_db_cluster.changed
        - "'allocated_storage' in _result_create_source_db_cluster"
        - _result_create_source_db_cluster.allocated_storage == 1
        - "'cluster_create_time' in _result_create_source_db_cluster"
        - _result_create_source_db_cluster.copy_tags_to_snapshot == false
        - "'db_cluster_arn' in _result_create_source_db_cluster"
        - _result_create_source_db_cluster.db_cluster_identifier == '{{ cluster_id }}'
        - "'db_cluster_parameter_group' in _result_create_source_db_cluster"
        - "'db_cluster_resource_id' in _result_create_source_db_cluster"
        - "'endpoint' in _result_create_source_db_cluster"
        - "'engine' in _result_create_source_db_cluster"
        - _result_create_source_db_cluster.engine == "aurora-postgresql"
        - "'engine_mode' in _result_create_source_db_cluster"
        - _result_create_source_db_cluster.engine_mode == "provisioned"
        - "'engine_version' in _result_create_source_db_cluster"
        - "'master_username' in _result_create_source_db_cluster"
        - _result_create_source_db_cluster.master_username == "{{ username }}"
        - "'port' in _result_create_source_db_cluster"
        - "'status' in _result_create_source_db_cluster"
        - _result_create_source_db_cluster.status == "available"
        - "'tags' in _result_create_source_db_cluster"
        - "'vpc_security_groups' in _result_create_source_db_cluster"

    # ------------------------------------------------------------------------------------------
    # Test stopping db clusters
    - name: Stop db clusters - checkmode
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: stopped
      register: check_stopped_cluster
      check_mode: yes

    - assert:
        that:
        - check_stopped_cluster.changed

    - name: Stop db clusters
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: stopped
      register: stopped_cluster

    - assert:
        that:
        - stopped_cluster.changed
    
    - name: Wait until db clusters state is stopped
      amazon.aws.rds_cluster_info:
        cluster_id: '{{ cluster_id }}'
      register: stopped_cluster_info
      retries: 30
      delay: 60
      until: stopped_cluster_info.clusters[0].status == "stopped"

    - name: Stop db clusters (idempotence) - checkmode
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: stopped
      register: check_stopped_cluster_idem
      check_mode: yes

    - assert:
        that:
        - not check_stopped_cluster_idem.changed

    - name: Stop db clusters (idempotence)
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: stopped
      register: stopped_cluster_idem

    - assert:
        that:
        - not stopped_cluster_idem.changed

    # ------------------------------------------------------------------------------------------
    # Test starting DB clusters
    - name: Start db clusters - checkmode
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: started
      register: started_cluster
      check_mode: yes

    - assert:
        that:
        - started_cluster.changed
    
    - name: Start db clusters
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: started
      register: started_cluster

    - assert:
        that:
        - started_cluster.changed
    
    - name: Start db clusters (idempotence) - checkmode
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: started
      register: check_started_cluster
      check_mode: yes

    - assert:
        that:
        - not check_started_cluster.changed

    - name: Start db clusters
      amazon.aws.rds_cluster:
        cluster_id: '{{ cluster_id }}'
        state: started
      register: started_cluster

    - assert:
        that:
        - not started_cluster.changed
  
    # ------------------------------------------------------------------------------------------
    # Cleanup starts here
  always:
    - name: Delete db cluster without creating a final snapshot
      rds_cluster:
        state: absent
        cluster_id: '{{ cluster_id }}'
        skip_final_snapshot: true
      ignore_errors: true

 #   # ------------------------------------------------------------------------------------------
  #   # Give erros for Postgres DB cluster
  #   - name: Ensure the resource doesn't exist
  #     rds_cluster:
  #       id: PostgresCluster
  #       state: absent
  #       engine: postgres
  #       username: '{{ username }}'
  #       password: '{{ password }}'
  #       skip_final_snapshot: true
  #     register: _result_delete_db_cluster
  
  #   - assert:
  #       that:
  #       - not _result_delete_db_cluster.changed
  #     ignore_errors: yes
    
  #   - name: Create an Postgres DB cluster
  #     rds_cluster:
  #       id: PostgresCluster
  #       state: present
  #       engine: postgres
  #       engine_mode: provisioned
  #       allocated_storage: 1
  #       iops: 1000
  #       db_cluster_instance_class: '{{ db_cluster_instance_class }}'
  #       username: 'PostgresCluster'
  #       password: '{{ password }}'
  #     register: postgres_cluster


  #   - assert:
  #       that:
  #       - postgres_cluster.changed
  #       - "'allocated_storage' in postgres_cluster"
  #       - postgres_cluster.allocated_storage == 1
  #       - "'cluster_create_time' in postgres_cluster"
  #       - postgres_cluster.copy_tags_to_snapshot == false
  #       - "'db_cluster_arn' in postgres_cluster"
  #       - postgres_cluster.db_cluster_identifier == "PostgresCluster"
  #       - "'db_cluster_parameter_group' in postgres_cluster"
  #       - "'db_cluster_resource_id' in postgres_cluster"
  #       - "'endpoint' in postgres_cluster"
  #       - "'engine' in postgres_cluster"
  #       - postgres_cluster.engine == "postgres"
  #       - "'engine_mode' in postgres_cluster"
  #       - postgres_cluster.engine_mode == "provisioned"
  #       - "'engine_version' in postgres_cluster"
  #       - "'master_username' in postgres_cluster"
  #       - postgres_cluster.master_username == "{{ username }}"
  #       - "'port' in postgres_cluster"
  #       - "'status' in postgres_cluster"
  #       - postgres_cluster.status == "available"
  #       - "'tags' in postgres_cluster"
  #       - "'vpc_security_groups' in postgres_cluster"
      

  #   - name: Stop Postgres DB cluster
  #     amazon.aws.rds_cluster:
  #       cluster_id: PostgresCluster
  #       state: stopped
  #     register: postgres_cluster
  #     ignore_errors: true

  #   - assert:
  #       that:
  #       - postgres_cluster is failed
  #       - postgres_cluster.msg == "Only aurora clusters can use the state started or stopped"

  # always:
  #   - name: Delete db cluster without creating a final snapshot
  #     rds_cluster:
  #       state: absent
  #       cluster_id: postgres_cluster
  #       skip_final_snapshot: true
  #     ignore_errors: true