<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guidelines for Ansible Amazon AWS module development &mdash; Ansible collections  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/ansible.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/antsibull-minimal.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/rtd-ethical-ads.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/images/Ansible-Mark-RGB_Black.png"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Dynamic Inventory Plugin" href="aws_ec2_guide.html" />
    <link rel="prev" title="Amazon Web Services Guide" href="guide_aws.html" /><!-- extra head elements for Ansible beyond RTD Sphinx Theme -->




</head>

<body class="wy-body-for-nav"><!-- extra body elements for Ansible beyond RTD Sphinx Theme -->

<div class="DocSite-globalNav ansibleNav">
  <ul>
    <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
    <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
    <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
    <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
    <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
  </ul>
</div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../../../../_static/images/Ansible-Mark-RGB_White.png"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">Ansible Collections Documentation</div>
</a>
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Ansible collections
          </a><!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    
  
</div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <label class="sr-only" for="q">Search docs:</label>
    <input type="text" class="st-default-search-input" id="q" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Collections:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Collection Index</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">Collections in the Amazon Namespace</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">Amazon.Aws</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../index.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#communication">Communication</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#changelog">Changelog</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#scenario-guide">Scenario Guide</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../index.html#module-development-guidelines">Module Development Guidelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#dynamic-inventory-plugin-guide">Dynamic Inventory Plugin Guide</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#plugin-index">Plugin Index</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Plugin indexes:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index_callback.html">Index of all Callback Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_inventory.html">Index of all Inventory Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_lookup.html">Index of all Lookup Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index_module.html">Index of all Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference indexes:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../environment_variables.html">Index of all Collection Environment Variables</a></li>
</ul>
<!-- extra nav elements for Ansible beyond RTD Sphinx Theme -->

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Ansible collections</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Collection Index</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Collections in the Amazon Namespace</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Amazon.Aws</a></li>
      <li class="breadcrumb-item active">Guidelines for Ansible Amazon AWS module development</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

  
           <div itemprop="articleBody">
             
  <section id="guidelines-for-ansible-amazon-aws-module-development">
<span id="ansible-collections-amazon-aws-docsite-dev-guide-intro"></span><h1>Guidelines for Ansible Amazon AWS module development<a class="headerlink" href="#guidelines-for-ansible-amazon-aws-module-development" title="Permalink to this heading"></a></h1>
<p>The Ansible AWS collection (on <a class="reference external" href="https://galaxy.ansible.com/community/aws">Galaxy</a>, source code <a class="reference external" href="https://github.com/ansible-collections/community.aws">repository</a>) is maintained by the Ansible AWS Working Group.  For further information see the <a class="reference external" href="https://github.com/ansible/community/wiki/aws">AWS working group community page</a>. If you are planning to contribute AWS modules to Ansible then getting in touch with the working group is a good way to start, especially because a similar module may already be under development.</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#requirements" id="id3">Requirements</a></p>
<ul>
<li><p><a class="reference internal" href="#python-compatibility" id="id4">Python Compatibility</a></p></li>
<li><p><a class="reference internal" href="#sdk-version-support" id="id5">SDK Version Support</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#maintaining-existing-modules" id="id6">Maintaining existing modules</a></p>
<ul>
<li><p><a class="reference internal" href="#changelogs" id="id7">Changelogs</a></p></li>
<li><p><a class="reference internal" href="#breaking-changes" id="id8">Breaking Changes</a></p></li>
<li><p><a class="reference internal" href="#adding-new-features" id="id9">Adding new features</a></p></li>
<li><p><a class="reference internal" href="#release-policy-and-backporting-merged-prs" id="id10">Release policy and backporting merged PRs</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#creating-new-aws-modules" id="id11">Creating new AWS modules</a></p>
<ul>
<li><p><a class="reference internal" href="#naming-your-module" id="id12">Naming your module</a></p></li>
<li><p><a class="reference internal" href="#use-boto3-and-ansibleawsmodule" id="id13">Use boto3 and AnsibleAWSModule</a></p></li>
<li><p><a class="reference internal" href="#importing-botocore-and-boto3" id="id14">Importing botocore and boto3</a></p></li>
<li><p><a class="reference internal" href="#supporting-module-defaults" id="id15">Supporting Module Defaults</a></p></li>
<li><p><a class="reference internal" href="#module-behavior" id="id16">Module behavior</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#connecting-to-aws" id="id17">Connecting to AWS</a></p>
<ul>
<li><p><a class="reference internal" href="#common-documentation-fragments-for-connection-parameters" id="id18">Common Documentation Fragments for Connection Parameters</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#handling-exceptions" id="id19">Handling exceptions</a></p>
<ul>
<li><p><a class="reference internal" href="#using-is-boto3-error-code" id="id20">Using is_boto3_error_code</a></p></li>
<li><p><a class="reference internal" href="#using-fail-json-aws" id="id21">Using fail_json_aws()</a></p></li>
<li><p><a class="reference internal" href="#using-fail-json-and-avoiding-ansibleawsmodule" id="id22">using fail_json() and avoiding AnsibleAWSModule</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#api-throttling-rate-limiting-and-pagination" id="id23">API throttling (rate limiting) and pagination</a></p></li>
<li><p><a class="reference internal" href="#returning-values" id="id24">Returning Values</a></p>
<ul>
<li><p><a class="reference internal" href="#tags" id="id25">Tags</a></p></li>
<li><p><a class="reference internal" href="#info-modules" id="id26">Info modules</a></p></li>
<li><p><a class="reference internal" href="#deprecating-return-values" id="id27">Deprecating return values</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#dealing-with-iam-json-policy" id="id28">Dealing with IAM JSON policy</a></p></li>
<li><p><a class="reference internal" href="#dealing-with-tags" id="id29">Dealing with tags</a></p></li>
<li><p><a class="reference internal" href="#helper-functions" id="id30">Helper functions</a></p>
<ul>
<li><p><a class="reference internal" href="#camel-dict-to-snake-dict" id="id31">camel_dict_to_snake_dict</a></p></li>
<li><p><a class="reference internal" href="#snake-dict-to-camel-dict" id="id32">snake_dict_to_camel_dict</a></p></li>
<li><p><a class="reference internal" href="#ansible-dict-to-boto3-filter-list" id="id33">ansible_dict_to_boto3_filter_list</a></p></li>
<li><p><a class="reference internal" href="#boto-exception" id="id34">boto_exception</a></p></li>
<li><p><a class="reference internal" href="#boto3-tag-list-to-ansible-dict" id="id35">boto3_tag_list_to_ansible_dict</a></p></li>
<li><p><a class="reference internal" href="#ansible-dict-to-boto3-tag-list" id="id36">ansible_dict_to_boto3_tag_list</a></p></li>
<li><p><a class="reference internal" href="#get-ec2-security-group-ids-from-names" id="id37">get_ec2_security_group_ids_from_names</a></p></li>
<li><p><a class="reference internal" href="#compare-policies" id="id38">compare_policies</a></p></li>
<li><p><a class="reference internal" href="#compare-aws-tags" id="id39">compare_aws_tags</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#integration-tests-for-aws-modules" id="id40">Integration Tests for AWS Modules</a></p>
<ul>
<li><p><a class="reference internal" href="#custom-sdk-versions-for-integration-tests" id="id41">Custom SDK versions for Integration Tests</a></p></li>
<li><p><a class="reference internal" href="#creating-ec2-instances-in-integration-tests" id="id42">Creating EC2 instances in Integration Tests</a></p></li>
<li><p><a class="reference internal" href="#resource-naming-in-integration-tests" id="id43">Resource naming in Integration Tests</a></p></li>
<li><p><a class="reference internal" href="#aws-credentials-for-integration-tests" id="id44">AWS Credentials for Integration Tests</a></p></li>
<li><p><a class="reference internal" href="#aws-permissions-for-integration-tests" id="id45">AWS Permissions for Integration Tests</a></p>
<ul>
<li><p><a class="reference internal" href="#troubleshooting-iam-policies" id="id46">Troubleshooting IAM policies</a></p></li>
<li><p><a class="reference internal" href="#unsupported-integration-tests" id="id47">Unsupported Integration tests</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#unit-tests-for-aws-plugins" id="id48">Unit-tests for AWS plugins</a></p>
<ul>
<li><p><a class="reference internal" href="#why-do-we-need-unit-tests-when-we-ve-got-functional-tests" id="id49">Why do we need unit-tests when we’ve got functional tests</a></p></li>
<li><p><a class="reference internal" href="#how-to-keep-my-code-simple" id="id50">How to keep my code simple?</a></p></li>
<li><p><a class="reference internal" href="#unit-tests-guidelines" id="id51">Unit-tests guidelines</a></p></li>
<li><p><a class="reference internal" href="#how-to-run-my-unit-tests" id="id52">How to run my unit-tests</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="requirements">
<span id="ansible-collections-amazon-aws-docsite-dev-python"></span><h2><a class="toc-backref" href="#id3" role="doc-backlink">Requirements</a><a class="headerlink" href="#requirements" title="Permalink to this heading"></a></h2>
<section id="python-compatibility">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Python Compatibility</a><a class="headerlink" href="#python-compatibility" title="Permalink to this heading"></a></h3>
<p>AWS content in Ansible 2.9 and 1.x collection releases supported Python 2.7 and newer.</p>
<p>Starting with the 2.0 releases of both collections, Python 2.7 support will be ended in accordance with AWS’ <a class="reference external" href="https://aws.amazon.com/blogs/developer/announcing-end-of-support-for-python-2-7-in-aws-sdk-for-python-and-aws-cli-v1/">end of Python 2.7 support</a>.  Contributions to both collections that target the 2.0 or later collection releases can be written to support Python 3.6+ syntax.</p>
</section>
<section id="sdk-version-support">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">SDK Version Support</a><a class="headerlink" href="#sdk-version-support" title="Permalink to this heading"></a></h3>
<p>Starting with the 2.0 releases of both collections, it is generally the policy to support the versions of botocore and boto3 that were released 12 months prior to the most recent major collection release, following semantic versioning (for example, 2.0.0, 3.0.0).</p>
<p>Features and functionality that require newer versions of the SDK can be contributed provided they are noted in the module documentation:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">DOCUMENTATION = &#39;&#39;&#39;</span>
<span class="nn">---</span>
<span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ec2_vol</span>
<span class="nt">options</span><span class="p">:</span>
<span class="w">  </span><span class="nt">throughput</span><span class="p">:</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Volume throughput in MB/s.</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">This parameter is only valid for gp3 volumes.</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Valid range is from 125 to 1000.</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Requires at least botocore version 1.19.27.</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
<span class="w">    </span><span class="nt">version_added</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.4.0</span>
</pre></div>
</div>
<p>And handled using the <code class="docutils literal notranslate"><span class="pre">botocore_at_least</span></code> helper method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;throughput&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">botocore_at_least</span><span class="p">(</span><span class="s2">&quot;1.19.27&quot;</span><span class="p">):</span>
        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;botocore &gt;= 1.19.27 is required to set the throughput for a volume&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Starting with the 4.0 releases of both collections, all support for the original boto SDK has been dropped.  AWS Modules must be written using the botocore and boto3 SDKs.</p>
</section>
</section>
<section id="maintaining-existing-modules">
<span id="ansible-collections-amazon-aws-docsite-dev-module-maint"></span><h2><a class="toc-backref" href="#id6" role="doc-backlink">Maintaining existing modules</a><a class="headerlink" href="#maintaining-existing-modules" title="Permalink to this heading"></a></h2>
<section id="changelogs">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Changelogs</a><a class="headerlink" href="#changelogs" title="Permalink to this heading"></a></h3>
<p>A changelog fragment must be added to any PR that changes functionality or fixes
a bug.  More information about changelog fragments can be found in the
<a class="reference external" href="https://docs.ansible.com/ansible-core/devel/community/development_process.html#community-changelogs" title="(in Ansible vdevel)"><code class="xref any docutils literal notranslate"><span class="pre">Making</span> <span class="pre">your</span> <span class="pre">PR</span> <span class="pre">merge-worthy</span> <span class="pre">section</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">Ansible</span> <span class="pre">Development</span> <span class="pre">Cycle</span> <span class="pre">documentation</span></code></a></p>
</section>
<section id="breaking-changes">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Breaking Changes</a><a class="headerlink" href="#breaking-changes" title="Permalink to this heading"></a></h3>
<p>Changes that are likely to break existing playbooks using the AWS collections should be
avoided, should only be made in a major release, and where practical should be
preceeded by a deprecation cycle of at least 1 full major release.  Deprecations
may be backported to the stable branches.</p>
<p>For example:
- A deprecation added in release 3.0.0 may be removed in release 4.0.0.
- A deprecation added in release 1.2.0 may be removed in release 3.0.0.</p>
<p>Breaking changes include:
- Removing a parameter.
- Making a parameter <code class="docutils literal notranslate"><span class="pre">required</span></code>.
- Updating the default value of a parameter.
- Changing or removing an existing return value.</p>
</section>
<section id="adding-new-features">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Adding new features</a><a class="headerlink" href="#adding-new-features" title="Permalink to this heading"></a></h3>
<p>Try to keep backward compatibility with versions of boto3/botocore that are at least a year old.
This means that if you want to implement functionality that uses a new feature of boto3/botocore,
it should only fail if that feature is explicitly used, with a message stating the missing feature
and minimum required version of botocore. (Feature support is usually defined in botocore and then
used by boto3)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="o">=</span> <span class="n">AnsibleAWSModule</span><span class="p">(</span>
    <span class="n">argument_spec</span><span class="o">=</span><span class="n">argument_spec</span><span class="p">,</span>
    <span class="o">...</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scope&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;managed&#39;</span><span class="p">:</span>
    <span class="n">module</span><span class="o">.</span><span class="n">require_botocore_at_least</span><span class="p">(</span><span class="s1">&#39;1.23.23&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s1">&#39;to list managed rules&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="release-policy-and-backporting-merged-prs">
<span id="ansible-collections-amazon-aws-docsite-dev-backports"></span><h3><a class="toc-backref" href="#id10" role="doc-backlink">Release policy and backporting merged PRs</a><a class="headerlink" href="#release-policy-and-backporting-merged-prs" title="Permalink to this heading"></a></h3>
<p>All amazon.aws and community.aws PRs must be merged to the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch first.  After a PR has
been accepted and merged to the <code class="docutils literal notranslate"><span class="pre">main</span></code> branch they can be backported to the stable branches.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">main</span></code> branch is a staging location for the next major version (X+1) of the collections and
may include breaking changes.</p>
<p>General backport policy:</p>
<ul class="simple">
<li><p>New features, deprecations and minor changes can be backported to the latest stable release.</p></li>
<li><p>Bugfixes can be backported to the 2 latest stable releases.</p></li>
<li><p>Security fixes should be backported to at least the 2 latest stable releases.</p></li>
</ul>
<p>Where necessary, additional CI related changes may be introduced to older stable branches to
ensure CI continues to function.</p>
<p>The simplest mechanism for backporting PRs is by adding the <code class="docutils literal notranslate"><span class="pre">backport-Y</span></code> label to a PR.  Once the
PR has been merged the patchback bot will attempt to automatically create a backport PR.</p>
</section>
</section>
<section id="creating-new-aws-modules">
<span id="ansible-collections-amazon-aws-docsite-dev-module-create"></span><h2><a class="toc-backref" href="#id11" role="doc-backlink">Creating new AWS modules</a><a class="headerlink" href="#creating-new-aws-modules" title="Permalink to this heading"></a></h2>
<p>When writing a new module it is important to think about the scope of the module.  In general, try
to do one thing and do it well.</p>
<p>Where the Amazon APIs provide a distinction between dependent resources, such as S3 buckets and S3
objects, this is often a good divider between modules.  Additionally, resources which have a
many-to-many relationship with another resource, such as IAM managed policies and IAM roles, are
often best managed by two separate modules.</p>
<p>While it’s possible to write an <code class="docutils literal notranslate"><span class="pre">s3</span></code> module which manages all things related to S3, thoroughly
testing and maintaining such a module is difficult.  Similarly, while it would be possible to
write a module that manages the base EC2 security group resource, and a second module to manage the
rules on the security group, this would be contrary to what users of the module might anticipate.</p>
<p>There is no hard and fast right answer, but it’s important to think about it, and Amazon have often
done this work for you when designing their APIs.</p>
<section id="naming-your-module">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Naming your module</a><a class="headerlink" href="#naming-your-module" title="Permalink to this heading"></a></h3>
<p>Module names should include the name of the resource being managed and be prefixed with the AWS API
that the module is based on.  Where examples of a prefix don’t already exist a good rule of thumb is
to use whatever client name you use with boto3 as a starting point.</p>
<p>Unless something is a well known abbreviation of a major component of AWS (for example, VPC or ELB)
avoid further abbreviating names and don’t create new abbreviations independently.</p>
<p>Where an AWS API primarily manages a single resource, the module managing this resource can be
named as just the name of the API.  However, consider using <code class="docutils literal notranslate"><span class="pre">instance</span></code> or <code class="docutils literal notranslate"><span class="pre">cluster</span></code> for clarity
if Amazon refers to them using these names.</p>
<p>Examples:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ec2_instance</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s3_object</span></code> (previously named <code class="docutils literal notranslate"><span class="pre">aws_s3</span></code>, but is primarily for manipulating S3 objects)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">elb_classic_lb</span></code> (previously <code class="docutils literal notranslate"><span class="pre">ec2_elb_lb</span></code>, but is part of the ELB API, not EC2)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">networkfirewall_rule_group</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">networkfirewall</span></code> (while this could be called <code class="docutils literal notranslate"><span class="pre">networkfirewall_firewall</span></code> the second firewall is redundant and the API is focused around creating these firewall resources)</p></li>
</ul>
<p>Note: Prior to the collections being split from Ansible Core, it was common to use <code class="docutils literal notranslate"><span class="pre">aws_</span></code> as a
prefix to disambiguate services with a generic name, such as <code class="docutils literal notranslate"><span class="pre">aws_secret</span></code>.  This is no longer
necessary, and the <code class="docutils literal notranslate"><span class="pre">aws_</span></code> prefix is reserved for services with a very broad effect where
referencing the AWS API might cause confusion.  For example, <code class="docutils literal notranslate"><span class="pre">aws_region_info</span></code>, which
connects to EC2 but provides global information about the regions enabled in an account for all
services.</p>
</section>
<section id="use-boto3-and-ansibleawsmodule">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Use boto3 and AnsibleAWSModule</a><a class="headerlink" href="#use-boto3-and-ansibleawsmodule" title="Permalink to this heading"></a></h3>
<p>All new AWS modules must use boto3/botocore and <code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code> greatly simplifies exception handling and library
management, reducing the amount of boilerplate code.  If you cannot
use <code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code> as a base, you must document the reason and request an exception to this rule.</p>
</section>
<section id="importing-botocore-and-boto3">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Importing botocore and boto3</a><a class="headerlink" href="#importing-botocore-and-boto3" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ansible_collections.amazon.aws.plugins.module_utils.botocore</span></code> module
automatically imports boto3 and botocore.  If boto3 is missing from the system then the variable
<code class="docutils literal notranslate"><span class="pre">HAS_BOTO3</span></code> will be set to <code class="docutils literal notranslate"><span class="pre">False</span></code>.  Normally, this means that modules don’t need to import
boto3 directly.  There is no need to check <code class="docutils literal notranslate"><span class="pre">HAS_BOTO3</span></code> when using AnsibleAWSModule
as the module does that check:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible_collections.amazon.aws.plugins.module_utils.modules</span> <span class="kn">import</span> <span class="n">AnsibleAWSModule</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">botocore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c1"># handled by AnsibleAWSModule</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="n">AnsibleModule</span>
<span class="kn">from</span> <span class="nn">ansible.module_utils.basic</span> <span class="kn">import</span> <span class="n">missing_required_lib</span>
<span class="kn">from</span> <span class="nn">ansible_collections.amazon.aws.plugins.module_utils.botocore</span> <span class="kn">import</span> <span class="n">HAS_BOTO3</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">botocore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c1"># handled by imported HAS_BOTO3</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">HAS_BOTO3</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">missing_required_lib</span><span class="p">(</span><span class="s1">&#39;botocore and boto3&#39;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="supporting-module-defaults">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Supporting Module Defaults</a><a class="headerlink" href="#supporting-module-defaults" title="Permalink to this heading"></a></h3>
<p>The existing AWS modules support using <a class="reference external" href="https://docs.ansible.com/ansible-core/devel/playbook_guide/playbooks_module_defaults.html#module-defaults" title="(in Ansible vdevel)"><span class="xref std std-ref">module_defaults</span></a> for common
authentication parameters.  To do the same for your new module, add an entry for it in
<code class="docutils literal notranslate"><span class="pre">meta/runtime.yml</span></code>.  These entries take the form of:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">action_groups</span><span class="p">:</span>
<span class="w">  </span><span class="nt">aws</span><span class="p">:</span>
<span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">     </span><span class="l l-Scalar l-Scalar-Plain">example_module</span>
</pre></div>
</div>
</section>
<section id="module-behavior">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Module behavior</a><a class="headerlink" href="#module-behavior" title="Permalink to this heading"></a></h3>
<p>To reduce the chance of breaking changes occurring when new features are added,
the module should avoid modifying the resource attribute when a parameter is
not explicitly set in a task.</p>
<p>By convention, when a parameter is explicitly set in a task, the module should
set the resource attribute to match what was set in the task.  In some cases,
such as tags or associations, it can be helpful to add an additional parameter
which can be set to change the behavior from replacive to additive.  However, the
default behavior should still be replacive rather than additive.</p>
<p>See the <a class="reference internal" href="#ansible-collections-amazon-aws-docsite-dev-tags"><span class="std std-ref">Dealing with tags</span></a>
section for an example with <code class="docutils literal notranslate"><span class="pre">tags</span></code> and <code class="docutils literal notranslate"><span class="pre">purge_tags</span></code>.</p>
</section>
</section>
<section id="connecting-to-aws">
<span id="ansible-collections-amazon-aws-docsite-dev-module-connection"></span><h2><a class="toc-backref" href="#id17" role="doc-backlink">Connecting to AWS</a><a class="headerlink" href="#connecting-to-aws" title="Permalink to this heading"></a></h2>
<p>AnsibleAWSModule provides the <code class="docutils literal notranslate"><span class="pre">resource</span></code> and <code class="docutils literal notranslate"><span class="pre">client</span></code> helper methods for obtaining boto3 connections.
These handle some of the more esoteric connection options, such as security tokens and boto profiles.</p>
<p>If using the basic AnsibleModule then you should use <code class="docutils literal notranslate"><span class="pre">get_aws_connection_info</span></code> and then <code class="docutils literal notranslate"><span class="pre">boto3_conn</span></code>
to connect to AWS as these handle the same range of connection options.</p>
<p>These helpers also check for missing profiles or a region not set when it needs to be, so you don’t have to.</p>
<p>An example of connecting to EC2 is shown below. Note that unlike boto there is no <code class="docutils literal notranslate"><span class="pre">NoAuthHandlerFound</span></code>
exception handling like in boto. Instead, an <code class="docutils literal notranslate"><span class="pre">AuthFailure</span></code> exception will be thrown when you use the
connection. To ensure that authorization, parameter validation and permissions errors are all caught,
you should catch <code class="docutils literal notranslate"><span class="pre">ClientError</span></code> and <code class="docutils literal notranslate"><span class="pre">BotoCoreError</span></code> exceptions with every boto3 connection call.
See exception handling:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">module</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or for the higher level EC2 resource:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">module</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>An example of the older style connection used for modules based on AnsibleModule rather than AnsibleAWSModule:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">region</span><span class="p">,</span> <span class="n">ec2_url</span><span class="p">,</span> <span class="n">aws_connect_params</span> <span class="o">=</span> <span class="n">get_aws_connection_info</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">boto3</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">boto3_conn</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">conn_type</span><span class="o">=</span><span class="s1">&#39;client&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">ec2_url</span><span class="p">,</span> <span class="o">**</span><span class="n">aws_connect_params</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">region</span><span class="p">,</span> <span class="n">ec2_url</span><span class="p">,</span> <span class="n">aws_connect_params</span> <span class="o">=</span> <span class="n">get_aws_connection_info</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">boto3</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">boto3_conn</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">conn_type</span><span class="o">=</span><span class="s1">&#39;client&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">ec2_url</span><span class="p">,</span> <span class="o">**</span><span class="n">aws_connect_params</span><span class="p">)</span>
</pre></div>
</div>
<section id="common-documentation-fragments-for-connection-parameters">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Common Documentation Fragments for Connection Parameters</a><a class="headerlink" href="#common-documentation-fragments-for-connection-parameters" title="Permalink to this heading"></a></h3>
<p>There are four <a class="reference external" href="https://docs.ansible.com/ansible-core/devel/dev_guide/developing_modules_documenting.html#module-docs-fragments" title="(in Ansible vdevel)"><span class="xref std std-ref">common documentation fragments</span></a>
that should be included into almost all AWS modules:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">boto3</span></code> - contains the minimum requirements for the collection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">common.modules</span></code> - contains the common boto3 connection parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">region.modules</span></code> - contains the common region parameter required for many AWS APIs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tags</span></code> - contains the common tagging parameters</p></li>
</ul>
<p>These fragments should be used rather than re-documenting these properties to ensure consistency
and that the more esoteric connection options are documented. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DOCUMENTATION</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">module: my_module</span>
<span class="s1"># some lines omitted here</span>
<span class="s1">extends_documentation_fragment:</span>
<span class="s1">    - amazon.aws.boto3</span>
<span class="s1">    - amazon.aws.common.modules</span>
<span class="s1">    - amazon.aws.region.modules</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
<p>Other plugin types have a slightly different document fragment format, and should use
the following fragments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">boto3</span></code> - contains the minimum requirements for the collection</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">common.plugins</span></code> - contains the common boto3 connection parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">region.plugins</span></code> - contains the common region parameter required for many AWS APIs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tags</span></code> - contains the common tagging parameters</p></li>
</ul>
<p>These fragments should be used rather than re-documenting these properties to ensure consistency
and that the more esoteric connection options are documented. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DOCUMENTATION</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">module: my_plugin</span>
<span class="s1"># some lines omitted here</span>
<span class="s1">extends_documentation_fragment:</span>
<span class="s1">    - amazon.aws.boto3</span>
<span class="s1">    - amazon.aws.common.plugins</span>
<span class="s1">    - amazon.aws.region.plugins</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="handling-exceptions">
<span id="ansible-collections-amazon-aws-docsite-dev-exceptions"></span><h2><a class="toc-backref" href="#id19" role="doc-backlink">Handling exceptions</a><a class="headerlink" href="#handling-exceptions" title="Permalink to this heading"></a></h2>
<p>You should wrap any boto3 or botocore call in a try block. If an exception is thrown, then there
are a number of possibilities for handling it.</p>
<ul class="simple">
<li><dl class="simple">
<dt>Catch the general <code class="docutils literal notranslate"><span class="pre">ClientError</span></code> or look for a specific error code with</dt><dd><p><code class="docutils literal notranslate"><span class="pre">is_boto3_error_code</span></code>.</p>
</dd>
</dl>
</li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">aws_module.fail_json_aws()</span></code> to report the module failure in a standard way.</p></li>
<li><p>Retry using AWSRetry.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">fail_json()</span></code> to report the failure without using <code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code>.</p></li>
<li><p>Do something custom in the case where you know how to handle the exception.</p></li>
</ul>
<p>For more information on botocore exception handling see the <a class="reference external" href="https://botocore.readthedocs.io/en/latest/client_upgrades.html#error-handling">botocore error documentation</a>.</p>
<section id="using-is-boto3-error-code">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Using is_boto3_error_code</a><a class="headerlink" href="#using-is-boto3-error-code" title="Permalink to this heading"></a></h3>
<p>To use <code class="docutils literal notranslate"><span class="pre">ansible_collections.amazon.aws.plugins.module_utils.botocore.is_boto3_error_code</span></code> to catch a single
AWS error code, call it in place of <code class="docutils literal notranslate"><span class="pre">ClientError</span></code> in your except clauses. In
this example, <em>only</em> the <code class="docutils literal notranslate"><span class="pre">InvalidGroup.NotFound</span></code> error code will be caught here,
and any other error will be raised for handling elsewhere in the program.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">describe_security_groups</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="k">except</span> <span class="n">is_boto3_error_code</span><span class="p">(</span><span class="s1">&#39;InvalidGroup.NotFound&#39;</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="n">do_something</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>  <span class="c1"># do something with the info that was successfully returned</span>
</pre></div>
</div>
</section>
<section id="using-fail-json-aws">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Using fail_json_aws()</a><a class="headerlink" href="#using-fail-json-aws" title="Permalink to this heading"></a></h3>
<p>In the AnsibleAWSModule there is a special method, <code class="docutils literal notranslate"><span class="pre">module.fail_json_aws()</span></code> for nice reporting of
exceptions.  Call this on your exception and it will report the error together with a traceback for
use in Ansible verbose mode.</p>
<p>You should use the AnsibleAWSModule for all new modules, unless not possible.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible_collections.amazon.aws.plugins.module_utils.modules</span> <span class="kn">import</span> <span class="n">AnsibleAWSModule</span>

<span class="c1"># Set up module parameters</span>
<span class="c1"># module params code here</span>

<span class="c1"># Connect to AWS</span>
<span class="c1"># connection code here</span>

<span class="c1"># Make a call to AWS</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">describe_frooble</span><span class="p">(</span><span class="n">FroobleName</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BotoCoreError</span><span class="p">,</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json_aws</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Couldn&#39;t obtain frooble </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that it should normally be acceptable to catch all normal exceptions here, however if you
expect anything other than botocore exceptions you should test everything works as expected.</p>
<p>If you need to perform an action based on the error boto3 returned, use the error code and the
<code class="docutils literal notranslate"><span class="pre">is_boto3_error_code()</span></code> helper.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a call to AWS</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">describe_frooble</span><span class="p">(</span><span class="n">FroobleName</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="k">except</span> <span class="n">is_boto3_error_code</span><span class="p">(</span><span class="s1">&#39;FroobleNotFound&#39;</span><span class="p">):</span>
    <span class="n">workaround_failure</span><span class="p">()</span>  <span class="c1"># This is an error that we can work around</span>
<span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BotoCoreError</span><span class="p">,</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=duplicate-except</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json_aws</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Couldn&#39;t obtain frooble </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="using-fail-json-and-avoiding-ansibleawsmodule">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">using fail_json() and avoiding AnsibleAWSModule</a><a class="headerlink" href="#using-fail-json-and-avoiding-ansibleawsmodule" title="Permalink to this heading"></a></h3>
<p>Boto3 provides lots of useful information when an exception is thrown so pass this to the user
along with the message.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible_collections.amazon.aws.plugins.module_utils.botocore</span> <span class="kn">import</span> <span class="n">HAS_BOTO3</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">botocore</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c1"># caught by imported HAS_BOTO3</span>

<span class="c1"># Connect to AWS</span>
<span class="c1"># connection code here</span>

<span class="c1"># Make a call to AWS</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">describe_frooble</span><span class="p">(</span><span class="n">FroobleName</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Couldn&#39;t obtain frooble </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
                     <span class="n">exception</span><span class="o">=</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
                     <span class="o">**</span><span class="n">camel_dict_to_snake_dict</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">))</span>
</pre></div>
</div>
<p>Note: we use <code class="docutils literal notranslate"><span class="pre">str(e)</span></code> rather than <code class="docutils literal notranslate"><span class="pre">e.message</span></code> as the latter doesn’t
work with python3</p>
<p>If you need to perform an action based on the error boto3 returned, use the error code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a call to AWS</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">describe_frooble</span><span class="p">(</span><span class="n">FroobleName</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FroobleNotFound&#39;</span><span class="p">:</span>
        <span class="n">workaround_failure</span><span class="p">()</span>  <span class="c1"># This is an error that we can work around</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Couldn&#39;t obtain frooble </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
                         <span class="n">exception</span><span class="o">=</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
                         <span class="o">**</span><span class="n">camel_dict_to_snake_dict</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">))</span>
<span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BotoCoreError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json_aws</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Couldn&#39;t obtain frooble </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="api-throttling-rate-limiting-and-pagination">
<span id="ansible-collections-amazon-aws-docsite-dev-ratelimits"></span><h2><a class="toc-backref" href="#id23" role="doc-backlink">API throttling (rate limiting) and pagination</a><a class="headerlink" href="#api-throttling-rate-limiting-and-pagination" title="Permalink to this heading"></a></h2>
<p>For methods that return a lot of results, boto3 often provides
<a class="reference external" href="https://boto3.readthedocs.io/en/latest/guide/paginators.html">paginators</a>. If the method
you’re calling has <code class="docutils literal notranslate"><span class="pre">NextToken</span></code> or <code class="docutils literal notranslate"><span class="pre">Marker</span></code> parameters, you should probably
check whether a paginator exists (the top of each boto3 service reference page has a link
to Paginators, if the service has any). To use paginators, obtain a paginator object,
call <code class="docutils literal notranslate"><span class="pre">paginator.paginate</span></code> with the appropriate arguments and then call <code class="docutils literal notranslate"><span class="pre">build_full_result</span></code>.</p>
<p>Any time that you are calling the AWS API a lot, you may experience API throttling,
and there is an <code class="docutils literal notranslate"><span class="pre">AWSRetry</span></code> decorator that can be used to ensure backoff. Because
exception handling could interfere with the retry working properly (as AWSRetry needs to
catch throttling exceptions to work correctly), you’d need to provide a backoff function
and then put exception handling around the backoff function.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">exponential_backoff</span></code> or <code class="docutils literal notranslate"><span class="pre">jittered_backoff</span></code> strategies - see
the cloud <code class="docutils literal notranslate"><span class="pre">module_utils</span></code> ()/lib/ansible/module_utils/cloud.py)
and <a class="reference external" href="https://www.awsarchitectureblog.com/2015/03/backoff.html">AWS Architecture blog</a> for more details.</p>
<p>The combination of these two approaches is then:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@AWSRetry</span><span class="o">.</span><span class="n">jittered_backoff</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">describe_some_resource_with_backoff</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
     <span class="n">paginator</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span><span class="s1">&#39;describe_some_resource&#39;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">paginator</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">build_full_result</span><span class="p">()[</span><span class="s1">&#39;SomeResource&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">describe_some_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="n">ansible_dict_to_boto3_filter_list</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">describe_some_resource_with_backoff</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">fail_json_aws</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Could not describe some resource&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Prior to Ansible 2.10 if the underlying <code class="docutils literal notranslate"><span class="pre">describe_some_resources</span></code> API call threw
a <code class="docutils literal notranslate"><span class="pre">ResourceNotFound</span></code> exception, <code class="docutils literal notranslate"><span class="pre">AWSRetry</span></code> would take this as a cue to retry until
it is not thrown (this is so that when creating a resource, we can just retry until it
exists).  This default was changed and it is now necessary to explicitly request
this behaviour.  This can be done by using the <code class="docutils literal notranslate"><span class="pre">catch_extra_error_codes</span></code>
argument on the decorator.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@AWSRetry</span><span class="o">.</span><span class="n">jittered_backoff</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">catch_extra_error_codes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ResourceNotFound&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">describe_some_resource_retry_missing</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
     <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="n">describe_some_resource</span><span class="p">(</span><span class="n">ResourceName</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])[</span><span class="s1">&#39;Resources&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">describe_some_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">describe_some_resource_with_backoff</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BotoCoreError</span><span class="p">,</span> <span class="n">botocore</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ClientError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">module</span><span class="o">.</span><span class="n">fail_json_aws</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Could not describe resource </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>To make use of AWSRetry easier, it can now be wrapped around a client returned
by <code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code>. any call from a client. To add retries to a client,
create a client:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">module</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">retry_decorator</span><span class="o">=</span><span class="n">AWSRetry</span><span class="o">.</span><span class="n">jittered_backoff</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>Any calls from that client can be made to use the decorator passed at call-time
using the <code class="docutils literal notranslate"><span class="pre">aws_retry</span></code> argument. By default, no retries are used.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ec2</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">,</span> <span class="n">retry_decorator</span><span class="o">=</span><span class="n">AWSRetry</span><span class="o">.</span><span class="n">jittered_backoff</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ec2</span><span class="o">.</span><span class="n">describe_instances</span><span class="p">(</span><span class="n">InstanceIds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;i-123456789&#39;</span><span class="p">],</span> <span class="n">aws_retry</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># equivalent with normal AWSRetry</span>
<span class="nd">@AWSRetry</span><span class="o">.</span><span class="n">jittered_backoff</span><span class="p">(</span><span class="n">retries</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">describe_instances</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ec2</span><span class="o">.</span><span class="n">describe_instances</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="n">describe_instances</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">),</span> <span class="n">InstanceIds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;i-123456789&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The call will be retried the specified number of times, so the calling functions
don’t need to be wrapped in the backoff decorator.</p>
<p>You can also use customization for <code class="docutils literal notranslate"><span class="pre">retries</span></code>, <code class="docutils literal notranslate"><span class="pre">delay</span></code> and <code class="docutils literal notranslate"><span class="pre">max_delay</span></code> parameters used by
<code class="docutils literal notranslate"><span class="pre">AWSRetry.jittered_backoff</span></code> API using module params. You can take a look at
the <code class="docutils literal notranslate"><span class="pre">cloudformation</span> <span class="pre">&lt;cloudformation_module&gt;</span></code> module for example.</p>
<dl class="simple">
<dt>To make all Amazon modules uniform, prefix the module param with <code class="docutils literal notranslate"><span class="pre">backoff_</span></code>, so <code class="docutils literal notranslate"><span class="pre">retries</span></code> becomes <code class="docutils literal notranslate"><span class="pre">backoff_retries</span></code></dt><dd><p>and likewise with <code class="docutils literal notranslate"><span class="pre">backoff_delay</span></code> and <code class="docutils literal notranslate"><span class="pre">backoff_max_delay</span></code>.</p>
</dd>
</dl>
</section>
<section id="returning-values">
<span id="ansible-collections-amazon-aws-docsite-dev-return"></span><h2><a class="toc-backref" href="#id24" role="doc-backlink">Returning Values</a><a class="headerlink" href="#returning-values" title="Permalink to this heading"></a></h2>
<p>When you make a call using boto3, you will probably get back some useful information that you
should return in the module.  As well as information related to the call itself, you will also have
some response metadata.  It is OK to return this to the user as well as they may find it useful.</p>
<p>Boto3 returns most keys in CamelCase.  Ansible adopts python standards for naming variables and usage.
There is a useful helper function called <code class="docutils literal notranslate"><span class="pre">camel_dict_to_snake_dict</span></code> that allows for an easy conversion
of the boto3 response to snake_case.  It resides in <code class="docutils literal notranslate"><span class="pre">module_utils/common/dict_transformations</span></code>.</p>
<p>You should use this helper function and avoid changing the names of values returned by Boto3.
E.g. if boto3 returns a value called ‘SecretAccessKey’ do not change it to ‘AccessKey’.</p>
<p>There is an optional parameter, <code class="docutils literal notranslate"><span class="pre">ignore_list</span></code>, which is used to avoid converting a sub-tree
of a dict.  This is particularly useful for tags, where keys are case-sensitive.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a call to AWS</span>
<span class="n">resource</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">aws_call</span><span class="p">()</span>

<span class="c1"># Convert resource response to snake_case</span>
<span class="n">snaked_resource</span> <span class="o">=</span> <span class="n">camel_dict_to_snake_dict</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Tags&#39;</span><span class="p">])</span>

<span class="c1"># Return the resource details to the user without modifying tags</span>
<span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">some_resource</span><span class="o">=</span><span class="n">snaked_resource</span><span class="p">)</span>
</pre></div>
</div>
<p>Note: The returned key representing the details of the specific resource (<code class="docutils literal notranslate"><span class="pre">some_resource</span></code> above)
should be a sensible approximation of the resource name.  For example, <code class="docutils literal notranslate"><span class="pre">volume</span></code> for <code class="docutils literal notranslate"><span class="pre">ec2_vol</span></code>,
<code class="docutils literal notranslate"><span class="pre">volumes</span></code> for <code class="docutils literal notranslate"><span class="pre">ec2_vol_info</span></code>.</p>
<section id="tags">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Tags</a><a class="headerlink" href="#tags" title="Permalink to this heading"></a></h3>
<p>Tags should be returned as a dictionary of key: value pairs, with each key being the tag’s
key and value being the tag’s value.  It should be noted, however, that boto3 often returns tags
as a list of dictionaries.</p>
<p>There is a helper function in module_utils/ec2.py called <code class="docutils literal notranslate"><span class="pre">boto3_tag_list_to_ansible_dict</span></code>
(discussed in detail below in the “Helper Functions” section) that allows for an easy conversion
from boto3’s returned tag list to the desired dictionary of tags to be returned by the module.</p>
<p>Below is a full example of getting the result of an AWS call and returning the expected values:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make a call to AWS</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">aws_call</span><span class="p">()</span>

<span class="c1"># Make result snake_case without modifying tags</span>
<span class="n">snaked_result</span> <span class="o">=</span> <span class="n">camel_dict_to_snake_dict</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ignore_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Tags&#39;</span><span class="p">])</span>

<span class="c1"># Convert boto3 list of dict tags to just a dict of tags</span>
<span class="n">snaked_result</span><span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boto3_tag_list_to_ansible_dict</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[]))</span>

<span class="c1"># Return the result to the user</span>
<span class="n">module</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">snaked_result</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="info-modules">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Info modules</a><a class="headerlink" href="#info-modules" title="Permalink to this heading"></a></h3>
<p>Info modules that can return information on multiple resources should return a list of
dictionaries, with each dictionary containing information about that particular resource
(i.e. <code class="docutils literal notranslate"><span class="pre">security_groups</span></code> in <code class="docutils literal notranslate"><span class="pre">ec2_group_info</span></code>).</p>
<p>In cases where the _info module only returns information on a singular resource
(i.e. <code class="docutils literal notranslate"><span class="pre">ec2_tag_info</span></code>), a singular dictionary should be returned as opposed to a list
of dictionaries.</p>
<p>In cases where the _info module returns no instances, an empty list ‘[]’ should be returned.</p>
<p>Keys in the returned dictionaries should follow the guidelines above and use snake_case.
If a return value can be used as a parameter for its corresponding main module, the key should
match either the parameter name itself, or an alias of that parameter.</p>
<p>The following is an example of improper usage of a sample info module with its respective main module:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;security_groups&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">    </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;description&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Created</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">ansible</span><span class="nv"> </span><span class="s">integration</span><span class="nv"> </span><span class="s">tests&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;group_id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;sg-050dba5c3520cba71&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;group_name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;ansible-test-87988625-unknown5c5f67f3ad09-icmp-1&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;ip_permissions&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[],</span>
<span class="w">        </span><span class="s">&quot;ip_permissions_egress&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[],</span>
<span class="w">        </span><span class="s">&quot;owner_id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;721066863947&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;tags&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">            </span><span class="p p-Indicator">{</span>
<span class="w">                </span><span class="s">&quot;Key&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Tag_One&quot;</span>
<span class="w">                </span><span class="s">&quot;Value&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Tag_One_Value&quot;</span>
<span class="w">            </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="p p-Indicator">],</span>
<span class="w">        </span><span class="s">&quot;vpc_id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;vpc-0cbc2380a326b8a0d&quot;</span>
<span class="w">    </span><span class="p p-Indicator">}</span>
<span class="p p-Indicator">}</span>
</pre></div>
</div>
<p>The sample output above shows a few mistakes in the sample security group info module:
* <code class="docutils literal notranslate"><span class="pre">security_groups</span></code> is a dict of dict, not a list of dicts.
* <code class="docutils literal notranslate"><span class="pre">tags</span></code> appears to be directly returned from boto3, since they’re a list of dicts.</p>
<p>The following is what the sample output would look like, with the mistakes corrected.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;security_groups&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[</span>
<span class="w">    </span><span class="p p-Indicator">{</span>
<span class="w">        </span><span class="s">&quot;description&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Created</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">ansible</span><span class="nv"> </span><span class="s">integration</span><span class="nv"> </span><span class="s">tests&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;group_id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;sg-050dba5c3520cba71&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;group_name&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;ansible-test-87988625-unknown5c5f67f3ad09-icmp-1&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;ip_permissions&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[],</span>
<span class="w">        </span><span class="s">&quot;ip_permissions_egress&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">[],</span>
<span class="w">        </span><span class="s">&quot;owner_id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;721066863947&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="s">&quot;tags&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="p p-Indicator">{</span>
<span class="w">            </span><span class="s">&quot;Tag_One&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;Tag_One_Value&quot;</span><span class="p p-Indicator">,</span>
<span class="w">        </span><span class="p p-Indicator">},</span>
<span class="w">        </span><span class="s">&quot;vpc_id&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;vpc-0cbc2380a326b8a0d&quot;</span>
<span class="w">    </span><span class="p p-Indicator">}</span>
<span class="p p-Indicator">]</span>
</pre></div>
</div>
</section>
<section id="deprecating-return-values">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Deprecating return values</a><a class="headerlink" href="#deprecating-return-values" title="Permalink to this heading"></a></h3>
<p>If changes need to be made to current return values, the new/”correct” keys should be
returned <strong>in addition to</strong> the existing keys to preserve compability with existing
playbooks. A deprecation should be added to the return values being replaced, initially
placed at least 2 years out, on the 1st of a month.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Deprecate old `iam_user` return key to be replaced by `user` introduced on 2022-04-10</span>
<span class="n">module</span><span class="o">.</span><span class="n">deprecate</span><span class="p">(</span><span class="s2">&quot;The &#39;iam_user&#39; return key is deprecated and will be replaced by &#39;user&#39;. Both values are returned for now.&quot;</span><span class="p">,</span>
                 <span class="n">date</span><span class="o">=</span><span class="s1">&#39;2024-05-01&#39;</span><span class="p">,</span> <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;community.aws&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="dealing-with-iam-json-policy">
<span id="ansible-collections-amazon-aws-docsite-dev-policies"></span><h2><a class="toc-backref" href="#id28" role="doc-backlink">Dealing with IAM JSON policy</a><a class="headerlink" href="#dealing-with-iam-json-policy" title="Permalink to this heading"></a></h2>
<p>If your module accepts IAM JSON policies then set the type to ‘json’ in the module spec. For
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">argument_spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">policy</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Note that AWS is unlikely to return the policy in the same order that is was submitted. Therefore,
use the <code class="docutils literal notranslate"><span class="pre">compare_policies</span></code> helper function which handles this variance.</p>
<p><code class="docutils literal notranslate"><span class="pre">compare_policies</span></code> takes two dictionaries, recursively sorts and makes them hashable for comparison
and returns True if they are different.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ansible_collections.amazon.aws.plugins.module_utils.iam</span> <span class="kn">import</span> <span class="n">compare_policies</span>

<span class="kn">import</span> <span class="nn">json</span>

<span class="c1"># some lines skipped here</span>

<span class="c1"># Get the policy from AWS</span>
<span class="n">current_policy</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">aws_object</span><span class="o">.</span><span class="n">get_policy</span><span class="p">())</span>
<span class="n">user_policy</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;policy&#39;</span><span class="p">))</span>

<span class="c1"># Compare the user submitted policy to the current policy ignoring order</span>
<span class="k">if</span> <span class="n">compare_policies</span><span class="p">(</span><span class="n">user_policy</span><span class="p">,</span> <span class="n">current_policy</span><span class="p">):</span>
    <span class="c1"># Update the policy</span>
    <span class="n">aws_object</span><span class="o">.</span><span class="n">set_policy</span><span class="p">(</span><span class="n">user_policy</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Nothing to do</span>
    <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="dealing-with-tags">
<span id="ansible-collections-amazon-aws-docsite-dev-tags"></span><h2><a class="toc-backref" href="#id29" role="doc-backlink">Dealing with tags</a><a class="headerlink" href="#dealing-with-tags" title="Permalink to this heading"></a></h2>
<p>AWS has a concept of resource tags. Usually the boto3 API has separate calls
for tagging and untagging a resource.  For example, the EC2 API has
<code class="docutils literal notranslate"><span class="pre">create_tags</span></code> and <code class="docutils literal notranslate"><span class="pre">delete_tags</span></code> calls.</p>
<p>When adding tagging support, Ansible AWS modules should add a <code class="docutils literal notranslate"><span class="pre">tags</span></code> parameter
that defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code> and a <code class="docutils literal notranslate"><span class="pre">purge_tags</span></code> parameter that defaults to
<code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">argument_spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">tags</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">purge_tags</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">purge_tags</span></code> parameter is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> <strong>and</strong> the <code class="docutils literal notranslate"><span class="pre">tags</span></code>
parameter is explicitly set in the task, then any tags not explicitly set in
<code class="docutils literal notranslate"><span class="pre">tags</span></code> should be removed.</p>
<p>If the <code class="docutils literal notranslate"><span class="pre">tags</span></code> parameter is not set then tags should not be modified, even if
<code class="docutils literal notranslate"><span class="pre">purge_tags</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.  This means that removing all tags requires
<code class="docutils literal notranslate"><span class="pre">tags</span></code> be explicitly set to an empty dictionary <code class="docutils literal notranslate"><span class="pre">{}</span></code> in the Ansible task.</p>
<p>There is a helper function <code class="docutils literal notranslate"><span class="pre">compare_aws_tags</span></code> to ease dealing with tags. It
compares two dictionaries, the current tags and the desired tags, and returns
the tags to set and the tags to delete.  See the Helper function section below
for more detail.</p>
<p>There is also a documentation fragment <code class="docutils literal notranslate"><span class="pre">amazon.aws.tags</span></code> which should be
included when adding tagging support.</p>
</section>
<section id="helper-functions">
<span id="ansible-collections-amazon-aws-docsite-dev-helpers"></span><h2><a class="toc-backref" href="#id30" role="doc-backlink">Helper functions</a><a class="headerlink" href="#helper-functions" title="Permalink to this heading"></a></h2>
<p>Along with the connection functions in Ansible ec2.py module_utils, there are some other useful
functions detailed below.</p>
<section id="camel-dict-to-snake-dict">
<h3><a class="toc-backref" href="#id31" role="doc-backlink">camel_dict_to_snake_dict</a><a class="headerlink" href="#camel-dict-to-snake-dict" title="Permalink to this heading"></a></h3>
<p>boto3 returns results in a dict.  The keys of the dict are in CamelCase format. In keeping with
Ansible format, this function will convert the keys to snake_case.</p>
<p><code class="docutils literal notranslate"><span class="pre">camel_dict_to_snake_dict</span></code> takes an optional parameter called <code class="docutils literal notranslate"><span class="pre">ignore_list</span></code> which is a list of
keys not to convert (this is usually useful for the <code class="docutils literal notranslate"><span class="pre">tags</span></code> dict, whose child keys should remain with
case preserved)</p>
<p>Another optional parameter is <code class="docutils literal notranslate"><span class="pre">reversible</span></code>. By default, <code class="docutils literal notranslate"><span class="pre">HTTPEndpoint</span></code> is converted to <code class="docutils literal notranslate"><span class="pre">http_endpoint</span></code>,
which would then be converted by <code class="docutils literal notranslate"><span class="pre">snake_dict_to_camel_dict</span></code> to <code class="docutils literal notranslate"><span class="pre">HttpEndpoint</span></code>.
Passing <code class="docutils literal notranslate"><span class="pre">reversible=True</span></code> converts HTTPEndpoint to <code class="docutils literal notranslate"><span class="pre">h_t_t_p_endpoint</span></code> which converts back to <code class="docutils literal notranslate"><span class="pre">HTTPEndpoint</span></code>.</p>
</section>
<section id="snake-dict-to-camel-dict">
<h3><a class="toc-backref" href="#id32" role="doc-backlink">snake_dict_to_camel_dict</a><a class="headerlink" href="#snake-dict-to-camel-dict" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">snake_dict_to_camel_dict</span></code> converts snake cased keys to camel case. By default, because it was
first introduced for ECS purposes, this converts to dromedaryCase. An optional
parameter called <code class="docutils literal notranslate"><span class="pre">capitalize_first</span></code>, which defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>, can be used to convert to CamelCase.</p>
</section>
<section id="ansible-dict-to-boto3-filter-list">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">ansible_dict_to_boto3_filter_list</a><a class="headerlink" href="#ansible-dict-to-boto3-filter-list" title="Permalink to this heading"></a></h3>
<p>Converts a an Ansible list of filters to a boto3 friendly list of dicts.  This is useful for any
boto3 <code class="docutils literal notranslate"><span class="pre">_facts</span></code> modules.</p>
</section>
<section id="boto-exception">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">boto_exception</a><a class="headerlink" href="#boto-exception" title="Permalink to this heading"></a></h3>
<p>Pass an exception returned from boto or boto3, and this function will consistently get the message from the exception.</p>
<p>Deprecated: use <code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code>’s <code class="docutils literal notranslate"><span class="pre">fail_json_aws</span></code> instead.</p>
</section>
<section id="boto3-tag-list-to-ansible-dict">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">boto3_tag_list_to_ansible_dict</a><a class="headerlink" href="#boto3-tag-list-to-ansible-dict" title="Permalink to this heading"></a></h3>
<p>Converts a boto3 tag list to an Ansible dict. Boto3 returns tags as a list of dicts containing keys
called ‘Key’ and ‘Value’ by default.  This key names can be overridden when calling the function.
For example, if you have already camel_cased your list of tags you may want to pass lowercase key
names instead, in other words, ‘key’ and ‘value’.</p>
<p>This function converts the list in to a single dict where the dict key is the tag key and the dict
value is the tag value.</p>
</section>
<section id="ansible-dict-to-boto3-tag-list">
<h3><a class="toc-backref" href="#id36" role="doc-backlink">ansible_dict_to_boto3_tag_list</a><a class="headerlink" href="#ansible-dict-to-boto3-tag-list" title="Permalink to this heading"></a></h3>
<p>Opposite of above. Converts an Ansible dict to a boto3 tag list of dicts. You can again override
the key names used if ‘Key’ and ‘Value’ is not suitable.</p>
</section>
<section id="get-ec2-security-group-ids-from-names">
<h3><a class="toc-backref" href="#id37" role="doc-backlink">get_ec2_security_group_ids_from_names</a><a class="headerlink" href="#get-ec2-security-group-ids-from-names" title="Permalink to this heading"></a></h3>
<p>Pass this function a list of security group names or combination of security group names and IDs
and this function will return a list of IDs.  You should also pass the VPC ID if known because
security group names are not necessarily unique across VPCs.</p>
</section>
<section id="compare-policies">
<h3><a class="toc-backref" href="#id38" role="doc-backlink">compare_policies</a><a class="headerlink" href="#compare-policies" title="Permalink to this heading"></a></h3>
<p>Pass two dicts of policies to check if there are any meaningful differences and returns true
if there are. This recursively sorts the dicts and makes them hashable before comparison.</p>
<p>This method should be used any time policies are being compared so that a change in order
doesn’t result in unnecessary changes.</p>
</section>
<section id="compare-aws-tags">
<h3><a class="toc-backref" href="#id39" role="doc-backlink">compare_aws_tags</a><a class="headerlink" href="#compare-aws-tags" title="Permalink to this heading"></a></h3>
<p>Pass two dicts of tags and an optional purge parameter and this function will return a dict
containing key pairs you need to modify and a list of tag key names that you need to remove.  Purge
is True by default.  If purge is False then any existing tags will not be modified.</p>
<p>This function is useful when using boto3 <code class="docutils literal notranslate"><span class="pre">add_tags</span></code> and <code class="docutils literal notranslate"><span class="pre">remove_tags</span></code> functions. Be sure to use the
other helper function <code class="docutils literal notranslate"><span class="pre">boto3_tag_list_to_ansible_dict</span></code> to get an appropriate tag dict before
calling this function. Since the AWS APIs are not uniform (for example, EC2 is different from Lambda) this will work
without modification for some (Lambda) and others may need modification before using these values
(such as EC2, with requires the tags to unset to be in the form <code class="docutils literal notranslate"><span class="pre">[{'Key':</span> <span class="pre">key1},</span> <span class="pre">{'Key':</span> <span class="pre">key2}]</span></code>).</p>
</section>
</section>
<section id="integration-tests-for-aws-modules">
<span id="ansible-collections-amazon-aws-docsite-dev-tests"></span><h2><a class="toc-backref" href="#id40" role="doc-backlink">Integration Tests for AWS Modules</a><a class="headerlink" href="#integration-tests-for-aws-modules" title="Permalink to this heading"></a></h2>
<p>All new AWS modules should include integration tests to ensure that any changes in AWS APIs that
affect the module are detected. At a minimum this should cover the key API calls and check the
documented return values are present in the module result.</p>
<p>For general information on running the integration tests see the <a class="reference external" href="https://docs.ansible.com/ansible-core/devel/dev_guide/testing_integration.html#testing-integration" title="(in Ansible vdevel)"><span class="xref std std-ref">Integration Tests page of the
Module Development Guide</span></a>, especially the section on configuration for cloud tests.</p>
<p>The integration tests for your module should be added in <code class="docutils literal notranslate"><span class="pre">test/integration/targets/MODULE_NAME</span></code>.</p>
<p>You must also have a aliases file in <code class="docutils literal notranslate"><span class="pre">test/integration/targets/MODULE_NAME/aliases</span></code>. This file serves
two purposes. First indicates it’s in an AWS test causing the test framework to make AWS credentials
available during the test run. Second putting the test in a test group causing it to be run in the
continuous integration build.</p>
<p>Tests for new modules should be added to the <code class="docutils literal notranslate"><span class="pre">cloud/aws</span></code> group. In general just copy
an existing aliases file such as the <a class="reference external" href="https://github.com/ansible-collections/amazon.aws/blob/master/tests/integration/targets/aws_s3/aliases">aws_s3 tests aliases file</a>.</p>
<section id="custom-sdk-versions-for-integration-tests">
<h3><a class="toc-backref" href="#id41" role="doc-backlink">Custom SDK versions for Integration Tests</a><a class="headerlink" href="#custom-sdk-versions-for-integration-tests" title="Permalink to this heading"></a></h3>
<p>By default integration tests will run against the earliest supported version of
the AWS SDK.  The current supported versions can be found in
<code class="docutils literal notranslate"><span class="pre">tests/integration/constraints.txt</span></code> and should not be updated.  Where a module
needs access to a later version of the SDK this can be installed by depending on
the <code class="docutils literal notranslate"><span class="pre">setup_botocore_pip</span></code> role and setting the <code class="docutils literal notranslate"><span class="pre">botocore_version</span></code> variable in
the <code class="docutils literal notranslate"><span class="pre">meta/main.yml</span></code> file for your tests.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">setup_botocore_pip</span>
<span class="w">    </span><span class="nt">vars</span><span class="p">:</span>
<span class="w">      </span><span class="nt">botocore_version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.20.24&quot;</span>
</pre></div>
</div>
</section>
<section id="creating-ec2-instances-in-integration-tests">
<h3><a class="toc-backref" href="#id42" role="doc-backlink">Creating EC2 instances in Integration Tests</a><a class="headerlink" href="#creating-ec2-instances-in-integration-tests" title="Permalink to this heading"></a></h3>
<p>When started, the integration tests will be passed <code class="docutils literal notranslate"><span class="pre">aws_region</span></code> as an extra var.
Any resources created should be created in in this region, this includes EC2
instances.  Since AMIs are region specific there is a role which can be
included which will query the APIs for an AMI to use and set the <code class="docutils literal notranslate"><span class="pre">ec2_ami_id</span></code>
fact.  This role can be included by adding the <code class="docutils literal notranslate"><span class="pre">setup_ec2_facts</span></code> role as a
dependency in the <code class="docutils literal notranslate"><span class="pre">meta/main.yml</span></code> file for your tests.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">setup_ec2_facts</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ec2_ami_id</span></code> fact can then be used in the tests.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create launch configuration 1</span>
<span class="w">  </span><span class="nt">community.aws.ec2_lc</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">resource_prefix</span><span class="nv"> </span><span class="s">}}-lc1&#39;</span>
<span class="w">    </span><span class="nt">image_id</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ec2_ami_id</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">assign_public_ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<span class="w">    </span><span class="nt">instance_type</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">ec2_instance_type</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">security_groups</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;{{</span><span class="nv"> </span><span class="s">sg.group_id</span><span class="nv"> </span><span class="s">}}&#39;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">device_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/xvda</span>
<span class="w">        </span><span class="nt">volume_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">        </span><span class="nt">volume_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gp2</span>
<span class="w">        </span><span class="nt">delete_on_termination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>To improve test result reproducability across regions, tests should use this
role and the fact it provides to chose an AMI to use.</p>
</section>
<section id="resource-naming-in-integration-tests">
<h3><a class="toc-backref" href="#id43" role="doc-backlink">Resource naming in Integration Tests</a><a class="headerlink" href="#resource-naming-in-integration-tests" title="Permalink to this heading"></a></h3>
<p>AWS has a range of limitations for the name of resources.  Where possible,
resource names should include a string which makes the resource names unique
to the test.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ansible-test</span></code> tool used for running the integration tests provides two
helpful extra vars: <code class="docutils literal notranslate"><span class="pre">resource_prefix</span></code> and <code class="docutils literal notranslate"><span class="pre">tiny_prefix</span></code> which are unique to the
test set, and should generally used as part of the name.  <code class="docutils literal notranslate"><span class="pre">resource_prefix</span></code> will generate a prefix based on the host the test is being run on.  Sometimes this may result in a resource name that exceeds the character limit allowed by AWS.  In these cases, <code class="docutils literal notranslate"><span class="pre">tiny_prefix</span></code> will provide a 12-character randomly generated prefix.</p>
</section>
<section id="aws-credentials-for-integration-tests">
<h3><a class="toc-backref" href="#id44" role="doc-backlink">AWS Credentials for Integration Tests</a><a class="headerlink" href="#aws-credentials-for-integration-tests" title="Permalink to this heading"></a></h3>
<p>The testing framework handles running the test with appropriate AWS credentials, these are made available
to your test in the following variables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aws_region</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aws_access_key</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aws_secret_key</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">security_token</span></code></p></li>
</ul>
<p>So all invocations of AWS modules in the test should set these parameters. To avoid duplicating these
for every call, it’s preferable to use <a class="reference external" href="https://docs.ansible.com/ansible-core/devel/playbook_guide/playbooks_module_defaults.html#module-defaults" title="(in Ansible vdevel)"><span class="xref std std-ref">module_defaults</span></a>. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">set connection information for aws modules and run tasks</span>
<span class="w">  </span><span class="nt">module_defaults</span><span class="p">:</span>
<span class="w">    </span><span class="nt">group/aws</span><span class="p">:</span>
<span class="w">      </span><span class="nt">aws_access_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">aws_access_key</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">aws_secret_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">aws_secret_key</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">security_token</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">security_token</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(omit)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<span class="w">      </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">aws_region</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="w">  </span><span class="nt">block</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Do Something</span>
<span class="w">    </span><span class="nt">ec2_instance</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">... params ...</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Do Something Else</span>
<span class="w">    </span><span class="nt">ec2_instance</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">... params ...</span>
</pre></div>
</div>
</section>
<section id="aws-permissions-for-integration-tests">
<h3><a class="toc-backref" href="#id45" role="doc-backlink">AWS Permissions for Integration Tests</a><a class="headerlink" href="#aws-permissions-for-integration-tests" title="Permalink to this heading"></a></h3>
<p>As explained in the <a class="reference external" href="https://docs.ansible.com/ansible-core/devel/dev_guide/testing_integration.html#testing-integration" title="(in Ansible vdevel)"><span class="xref std std-ref">Integration Test guide</span></a>
there are defined IAM policies in <a class="reference external" href="https://github.com/mattclay/aws-terminator">mattclay/aws-terminator</a> that contain the necessary permissions
to run the AWS integration test.</p>
<p>If your module interacts with a new service or otherwise requires new permissions, tests will fail when you submit a pull request and the
<a class="reference external" href="https://github.com/ansible/ansibullbot/blob/master/ISSUE_HELP.md">Ansibullbot</a> will tag your PR as needing revision.
We do not automatically grant additional permissions to the roles used by the continuous integration builds.
You will need to raise a Pull Request against <a class="reference external" href="https://github.com/mattclay/aws-terminator">mattclay/aws-terminator</a> to add them.</p>
<p>If your PR has test failures, check carefully to be certain the failure is only due to the missing permissions. If you’ve ruled out other sources of failure, add a comment with the <code class="docutils literal notranslate"><span class="pre">ready_for_review</span></code>
tag and explain that it’s due to missing permissions.</p>
<p>Your pull request cannot be merged until the tests are passing. If your pull request is failing due to missing permissions,
you must collect the minimum IAM permissions required to
run the tests.</p>
<p>There are two ways to figure out which IAM permissions you need for your PR to pass:</p>
<ul class="simple">
<li><p>Start with the most permissive IAM policy, run the tests to collect information about which resources your tests actually use, then construct a policy based on that output. This approach only works on modules that use <code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code>.</p></li>
<li><p>Start with the least permissive IAM policy, run the tests to discover a failure, add permissions for the resource that addresses that failure, then repeat. If your module uses <code class="docutils literal notranslate"><span class="pre">AnsibleModule</span></code> instead of <code class="docutils literal notranslate"><span class="pre">AnsibleAWSModule</span></code>, you must use this approach.</p></li>
</ul>
<p>To start with the most permissive IAM policy:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create.html#access_policies_create-start">Create an IAM policy</a> that allows all actions (set <code class="docutils literal notranslate"><span class="pre">Action</span></code> and <code class="docutils literal notranslate"><span class="pre">Resource</span></code> to <code class="docutils literal notranslate"><span class="pre">*</span></code>).</p></li>
<li><p>Run your tests locally with this policy. On AnsibleAWSModule-based modules, the <code class="docutils literal notranslate"><span class="pre">debug_botocore_endpoint_logs</span></code> option is automatically set to <code class="docutils literal notranslate"><span class="pre">yes</span></code>, so you should see a list of AWS ACTIONS after the PLAY RECAP showing all the permissions used. If your tests use a boto/AnsibleModule module, you must start with the least permissive policy (see below).</p></li>
<li><p>Modify your policy to allow only the actions your tests use. Restrict account, region, and prefix where possible. Wait a few minutes for your policy to update.</p></li>
<li><p>Run the tests again with a user or role that allows only the new policy.</p></li>
<li><p>If the tests fail, troubleshoot (see tips below), modify the policy, run the tests again, and repeat the process until the tests pass with a restrictive policy.</p></li>
<li><p>Open a pull request proposing the minimum required policy to the <a class="reference external" href="https://github.com/mattclay/aws-terminator/tree/master/aws/policy">CI policies</a>.</p></li>
</ol>
<p>To start from the least permissive IAM policy:</p>
<ol class="arabic simple">
<li><p>Run the integration tests locally with no IAM permissions.</p></li>
<li><dl class="simple">
<dt>Examine the error when the tests reach a failure.</dt><dd><ol class="loweralpha simple">
<li><p>If the error message indicates the action used in the request, add the action to your policy.</p></li>
<li><dl class="simple">
<dt>If the error message does not indicate the action used in the request:</dt><dd><ul class="simple">
<li><p>Usually the action is a CamelCase version of the method name - for example, for an ec2 client the method <code class="docutils literal notranslate"><span class="pre">describe_security_groups</span></code> correlates to the action <code class="docutils literal notranslate"><span class="pre">ec2:DescribeSecurityGroups</span></code>.</p></li>
<li><p>Refer to the documentation to identify the action.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>If the error message indicates the resource ARN used in the request, limit the action to that resource.</p></li>
<li><dl class="simple">
<dt>If the error message does not indicate the resource ARN used:</dt><dd><ul class="simple">
<li><p>Determine if the action can be restricted to a resource by examining the documentation.</p></li>
<li><p>If the action can be restricted, use the documentation to construct the ARN and add it to the policy.</p></li>
</ul>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</li>
<li><p>Add the action or resource that caused the failure to <a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_create.html#access_policies_create-start">an IAM policy</a>. Wait a few minutes for your policy to update.</p></li>
<li><p>Run the tests again with this policy attached to your user or role.</p></li>
<li><p>If the tests still fail at the same place with the same error you will need to troubleshoot (see tips below). If the first test passes, repeat steps 2 and 3 for the next error. Repeat the process until the tests pass with a restrictive policy.</p></li>
<li><p>Open a pull request proposing the minimum required policy to the <a class="reference external" href="https://github.com/mattclay/aws-terminator/tree/master/aws/policy">CI policies</a>.</p></li>
</ol>
<section id="troubleshooting-iam-policies">
<h4><a class="toc-backref" href="#id46" role="doc-backlink">Troubleshooting IAM policies</a><a class="headerlink" href="#troubleshooting-iam-policies" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>When you make changes to a policy, wait a few minutes for the policy to update before re-running the tests.</p></li>
<li><p>Use the <a class="reference external" href="https://policysim.aws.amazon.com/">policy simulator</a> to verify that each action (limited by resource when applicable) in your policy is allowed.</p></li>
<li><p>If you’re restricting actions to certain resources, replace resources temporarily with <code class="docutils literal notranslate"><span class="pre">*</span></code>. If the tests pass with wildcard resources, there is a problem with the resource definition in your policy.</p></li>
<li><p>If the initial troubleshooting above doesn’t provide any more insight, AWS may be using additional undisclosed resources and actions.</p></li>
<li><p>Examine the AWS FullAccess policy for the service for clues.</p></li>
<li><p>Re-read the AWS documentation, especially the list of <a class="reference external" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_actions-resources-contextkeys.html">Actions, Resources and Condition Keys</a> for the various AWS services.</p></li>
<li><p>Look at the <a class="reference external" href="https://iam.cloudonaut.io">cloudonaut</a> documentation as a troubleshooting cross-reference.</p></li>
<li><p>Use a search engine.</p></li>
<li><p>Ask in the #ansible-aws chat channel (using Matrix at ansible.im or using IRC at <a class="reference external" href="https://libera.chat/">irc.libera.chat</a>).</p></li>
</ul>
</section>
<section id="unsupported-integration-tests">
<h4><a class="toc-backref" href="#id47" role="doc-backlink">Unsupported Integration tests</a><a class="headerlink" href="#unsupported-integration-tests" title="Permalink to this heading"></a></h4>
<p>There are a limited number of reasons why it may not be practical to run integration
tests for a module within CI.  Where these apply you should add the keyword
<code class="docutils literal notranslate"><span class="pre">unsupported</span></code> to the aliases file in <code class="docutils literal notranslate"><span class="pre">test/integration/targets/MODULE_NAME/aliases</span></code>.</p>
<p>Some cases where tests should be marked as unsupported:
1) The tests take longer than 10 or 15 minutes to complete
2) The tests create expensive resources
3) The tests create inline policies
4) The tests require the existence of external resources
5) The tests manage Account level security policies such as the password policy or AWS Organizations.</p>
<p>Where one of these reasons apply you should open a pull request proposing the minimum required policy to the
<a class="reference external" href="https://github.com/mattclay/aws-terminator/tree/master/hacking/aws_config/test_policies">unsupported test policies</a>.</p>
<p>Unsupported integration tests will not be automatically run by CI.  However, the
necessary policies should be available so that the tests can be manually run by
someone performing a PR review or writing a patch.</p>
</section>
</section>
</section>
<section id="unit-tests-for-aws-plugins">
<h2><a class="toc-backref" href="#id48" role="doc-backlink">Unit-tests for AWS plugins</a><a class="headerlink" href="#unit-tests-for-aws-plugins" title="Permalink to this heading"></a></h2>
<section id="why-do-we-need-unit-tests-when-we-ve-got-functional-tests">
<h3><a class="toc-backref" href="#id49" role="doc-backlink">Why do we need unit-tests when we’ve got functional tests</a><a class="headerlink" href="#why-do-we-need-unit-tests-when-we-ve-got-functional-tests" title="Permalink to this heading"></a></h3>
<p>Unit-tests are much faster and more suitable to test corner cases. They also don’t depend on a third party service
and thus, a failure is less likely to be a false positive.</p>
</section>
<section id="how-to-keep-my-code-simple">
<h3><a class="toc-backref" href="#id50" role="doc-backlink">How to keep my code simple?</a><a class="headerlink" href="#how-to-keep-my-code-simple" title="Permalink to this heading"></a></h3>
<p>Ideally, you should break up your code in tiny functions. Each function should have a limited number of parameters
and a low amount of cross dependencies with the rest of the code (low coupling):</p>
<ul class="simple">
<li><p>Don’t pass a large data structure to a function if it only uses one field. This clarifies the inputs of your
function (the contract) and also reduces the risk of an unexpected transformation of the data structure
from within the function.</p></li>
<li><p>The boto client object is complex and can be source of unwanted side-effect. It’s better to isolate the calls
in dedicated functions. These functions will have their own unit-tests.</p></li>
<li><p>Don’t pass the <code class="docutils literal notranslate"><span class="pre">module</span></code> object when you only need the read a couple of parameters from <code class="docutils literal notranslate"><span class="pre">module.params</span></code>.
Pass the parameter directly to your function. By doing so, you’re explicit about the function’s inputs
(the contract) and you reduce potential side-effect.</p></li>
</ul>
</section>
<section id="unit-tests-guidelines">
<h3><a class="toc-backref" href="#id51" role="doc-backlink">Unit-tests guidelines</a><a class="headerlink" href="#unit-tests-guidelines" title="Permalink to this heading"></a></h3>
<p>Ideally, all the <code class="docutils literal notranslate"><span class="pre">module_utils</span></code> should be covered by unit-tests. However we acknowledge that writing unit-tests may
be challenging and we also accept contribution with no unit-test. Generally speaking, unit-tests are recommended and likely to speed up the PR reviews.</p>
<ul class="simple">
<li><p>Our tests are run with <code class="docutils literal notranslate"><span class="pre">pytest</span></code> and we use the features it provides such as Fixtures, Parametrization.</p></li>
<li><p>The use of <code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> is discouraged for the sake of consistency and simplicity.</p></li>
<li><p>Unit-tests should run fine without any network connection.</p></li>
<li><p>It’s not necessary to mock all the boto3/botocore calls (<code class="docutils literal notranslate"><span class="pre">get_paginator()</span></code>, <code class="docutils literal notranslate"><span class="pre">paginate()</span></code>, etc). It’s often better to just set-up a function that wraps these calls and mock the result.</p></li>
<li><p>Simplicity prevails. Tests should be short and cover a limited set of features.</p></li>
</ul>
<p>Pytest is well documented and you will find some example in its <a class="reference external" href="https://docs.pytest.org/en/latest/how-to/index.html">how-to guides</a></p>
</section>
<section id="how-to-run-my-unit-tests">
<h3><a class="toc-backref" href="#id52" role="doc-backlink">How to run my unit-tests</a><a class="headerlink" href="#how-to-run-my-unit-tests" title="Permalink to this heading"></a></h3>
<p>In our CI, the testing is done by <code class="docutils literal notranslate"><span class="pre">ansible-test</span></code>. You can run the tests locally with the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>ansible-test<span class="w"> </span>units<span class="w"> </span>--docker
</pre></div>
</div>
<p>We also provide a <code class="docutils literal notranslate"><span class="pre">tox</span></code> configuration which allow you to run one specific test faster. In this example, we focus on the tests for the <code class="docutils literal notranslate"><span class="pre">s3_object</span></code> module:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>tox<span class="w"> </span>-e<span class="w"> </span>py3<span class="w"> </span>--<span class="w"> </span>tests/unit/plugins/modules/test_s3_object.py
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          

<footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="guide_aws.html" class="btn btn-neutral float-left" title="Amazon Web Services Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="aws_ec2_guide.html" class="btn btn-neutral float-right" title="Dynamic Inventory Plugin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ansible contributors.</p>
  </div>

  
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script><!-- extra footer elements for Ansible beyond RTD Sphinx Theme -->

</body>
</html>