---
# COMPUTE

amazon.aws.ec2_instance_info:
  query: >-
    .instances[] | select(. != null) | {
      name: (.name // .tags.Name // "UNKNOWN"),  # unique identifier for the resource
      canonical_facts: {
      id: .instance_id,
      status: .state.name,
      tags: (.tags // {}),
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Compute",
        device_type: "EC2"
        },
      }

# STORAGE

amazon.aws.s3_bucket_info:
  query: >-
    .buckets[] | select(. != null) |
    {
      canonical_facts: {
        name: .name,
        tags: (.bucket_tagging // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Storage",
        device_type: "Bucket"
      }
    }

amazon.aws.s3_object_info:
  query: >-
    .object_info[] | select(. != null) |
    {
      canonical_facts: {
        name: .object_name,
        tags: (.object_tagging // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Storage",
        device_type: "Object"
      }
    }

# NETWORKING

amazon.aws.elb_application_lb_info:
  query: >-
    .load_balancers[] | select(. != null) |
    {
      canonical_facts: {
        name: .load_balancer_name,
        status: .state.code,
        tags: (.tags // {}),
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "ApplicationLoadBalancer"
      },
    }

amazon.aws.elb_classic_lb_info:
  query: >-
    .elbs[] | select(. != null) |
    {
      canonical_facts: {
        name: .load_balancer_name,
        tags: (.tags // {}),
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "ClassicLoadBalancer"
      },
    }

amazon.aws.ec2_vpc_net_info:
  query: >-
    .vpcs[] | select(. != null) | {
        name: (.name // .tags.Name // "UNKNOWN"),
        canonical_facts: {
          id: .id,
          status: .state,
          tags: (.tags // {})
        },
        facts: {
          infra_type: "PublicCloud",
          infra_bucket: "Networking",
          device_type: "VPC"
        }
      }

amazon.aws.ec2_vpc_subnet_info:
  query: >-
    .subnets[] | select(. != null) | {
      canonical_facts: {
        id: .id,
        status: .state,
        tags: (.tags // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "Subnet"
      }
    }

amazon.aws.ec2_vpc_nat_gateway_info:
  query: >-
    .result[] | select(. != null) |
    {
      canonical_facts: {
        id: .nat_gateway_id,
        status: .state,
        tags: (.tags // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "NAT Gateway"
      }
    }

amazon.aws.ec2_vpc_igw_info:
  query: >-
    .internet_gateways[] | select(. != null) |
    {
      canonical_facts: {
        id: .internet_gateway_id,
        status: (.attachments | map({vpc_id: .vpc_id, status: .state})),
        tags: (.tags // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "Internet Gateway"
      }
    }

amazon.aws.ec2_vpc_vgw_info:
  query: >-
    .virtual_gateways[] | select(. != null) |
    {
      canonical_facts: {
        id: .vpn_gateway_id,
        status: .state,
        tags: (.resource_tags // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "Virtual Gateway"
      }
    }

amazon.aws.ec2_vpc_route_table_info:
  query: >-
    .route_tables[] | select(. != null) |
    {
      canonical_facts: {
        id: .route_table_id,
        tags: (.tags // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "Route table"
      }
    }

amazon.aws.ec2_vpc_vpn_info:
  query: >-
    .vpn_connections[] | select(. != null) |
    {
      canonical_facts: {
        id: .vpn_connection_id,
        status: .state,
        tags: (.tags // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "VPN Connection"
      }
    }

amazon.aws.ec2_vpc_peering_info:
  query: >-
    .vpc_peering_connections[] | select(. != null) |
    {
      canonical_facts: {
        id: .vpc_peering_connection_id,
        status: .status.code,
        tags: (.tags // {})
      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Networking",
        device_type: "VPC Peering"
      }
    }

# DATABASE

amazon.aws.rds_instance_info:
  query: >-
    .instances[] | select(. != null) |
    {
      canonical_facts: {
        id: .dbi_resource_id,  # AWS Region-unique, immutable identifier for the DB instance.
        name: .db_instance_identifier,  # The user-supplied DB cluster identifier.
        tags: (.tags // {}),
        status: .db_instance_status

      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Database",
        device_type: "Instance"
      }
    }

amazon.aws.rds_cluster_info:
  query: >-
    .clusters[] | select(. != null) |
    {
      canonical_facts: {
        id: .db_cluster_resource_id,  # The AWS Region-unique, immutable identifier for the DB cluster.
        name: .db_cluster_identifier,  # The user-supplied DB cluster identifier.
        tags: (.tags // {}),
        status: .status

      },
      facts: {
        infra_type: "PublicCloud",
        infra_bucket: "Database",
        device_type: "Cluster"
      }
    }
